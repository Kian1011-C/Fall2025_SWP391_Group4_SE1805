<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="SWP201 - Hệ thống đổi pin xe máy điện thông minh - Quản lý người dùng, trạm, thanh toán với bản đồ tương tác" />
  <title>SWP201 - Hệ Thống Đổi Pin Xe Máy Điện</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <style>
    :root{
      --bg:#0b1020;
      --card:#121831;
      --muted:#9aa4c7;
      --text:#e8ecff;
      --brand:#4f8cff;
      --brand-2:#6ae3ff;
      --ok:#19c37d;
      --warn:#ffb020;
      --danger:#ff5573;
      --ring:rgba(111,153,255,.45);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius-sm:10px;
      --radius-lg:20px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b1020 0%,#0e1430 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}
    a{color:inherit;text-decoration:none}
    .container{max-width:1120px;margin:0 auto;padding:0 20px}
    
    /* Header */
    header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(1.2) blur(10px);background:rgba(10,14,32,.55);border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo svg{width:18px;height:18px;fill:white}
    .nav-links{display:flex;gap:18px}
    .nav-links a:hover{color:var(--brand-2)}
    .auth-buttons{display:flex;gap:10px}
    
    /* Buttons */
    .btn{padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);color:var(--text);cursor:pointer;font-size:14px;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none;color:#061023;font-weight:700}
    .btn-success{background:linear-gradient(135deg,var(--ok),#9effce);border:none;color:#061023;font-weight:700}
    .btn-warning{background:linear-gradient(135deg,var(--warn),#ffd0a0);border:none;color:#061023;font-weight:700}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#ff8fa3);border:none;color:white;font-weight:700}
    .btn:hover{border-color:rgba(255,255,255,.2);transform:translateY(-1px)}
    .btn-primary:hover{box-shadow:0 8px 25px rgba(79,140,255,.3)}
    
    /* Hero */
    .hero{padding:56px 0 18px;text-align:center;background:radial-gradient(1200px 500px at 50% -50%,rgba(111,153,255,.25),transparent 60%),radial-gradient(600px 280px at 0% 0%,rgba(106,227,255,.16),transparent 60%),radial-gradient(600px 280px at 100% 0%,rgba(106,227,255,.12),transparent 60%)}
    .eyebrow{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:13px;background:rgba(255,255,255,.03);margin-bottom:18px}
    .title{font-size:44px;line-height:1.1;margin:18px 0 14px}
    .title strong{background:linear-gradient(135deg,#fff,#9bc2ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{color:var(--muted);max-width:780px;margin:0 auto 22px;font-size:16px}
    .hero-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:6px}
    
    /* Sections */
    section{padding:36px 0}
    .grid{display:grid;gap:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);transition:all .3s}
    .card:hover{border-color:rgba(255,255,255,.2);transform:translateY(-2px)}
    .card.featured{border-color:var(--brand);box-shadow:0 10px 40px rgba(79,140,255,.2)}
    .icon{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;margin-bottom:10px;background:linear-gradient(135deg,rgba(79,140,255,.25),rgba(106,227,255,.18));border:1px solid rgba(255,255,255,.12);font-size:18px}
    
    h1,h2,h3,h4,h5,h6{margin:0}
    h2{font-size:26px;margin:0 0 12px}
    h3{margin:8px 0 6px}
    h4{margin:12px 0 8px;color:var(--brand-2)}
    .muted{color:var(--muted);font-size:14px}
    
    /* Features */
    #features .grid{grid-template-columns:repeat(3,1fr)}
    
    /* Pricing */
    .pricing{display:grid;gap:18px;grid-template-columns:repeat(3,1fr)}
    .price{font-size:28px;font-weight:800;margin:8px 0}
    .chip{display:inline-block;font-size:12px;color:#061023;background:linear-gradient(135deg,var(--ok),#9effce);padding:6px 10px;border-radius:999px;margin-left:8px}
    ul.clean{list-style:none;padding:0;margin:12px 0 0}
    ul.clean li{display:flex;gap:8px;align-items:flex-start;margin:8px 0;color:var(--muted)}
    .tick{color:var(--ok);font-weight:800}
    
    /* Map */
    .map-container{margin:20px 0;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .station-info{margin-top:20px}
    .stations{grid-template-columns:repeat(3,1fr)}
    
    /* Contact */
    .contact-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    
    /* Footer */
    footer{padding:22px 0;color:var(--muted);border-top:1px solid rgba(255,255,255,.08);margin-top:28px}
    .footer-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:20px}
    .footer-grid a{display:block;margin:4px 0;color:var(--muted);transition:color .2s}
    .footer-grid a:hover{color:var(--brand-2)}
    .footer-bottom{text-align:center;padding-top:20px;border-top:1px solid rgba(255,255,255,.06);font-size:14px}
    
    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
    .modal-content{background:var(--card);margin:5% auto;padding:0;border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);width:90%;max-width:500px;box-shadow:var(--shadow);animation:modalSlideIn .3s ease}
    @keyframes modalSlideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,.1)}
    .modal-header h3{margin:0}
    .close-btn{background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .2s}
    .close-btn:hover{background:rgba(255,255,255,.1);color:var(--text)}
    
    /* Forms */
    form{padding:24px}
    .form-group{margin-bottom:16px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-group label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:500}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font-size:14px;outline:none;transition:all .2s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
    .form-actions{display:flex;gap:12px;margin-top:20px}
    .form-actions .btn{flex:1}
    
    /* Demo Accounts */
    .demo-accounts{padding:0 24px 24px;border-top:1px solid rgba(255,255,255,.1);margin-top:20px;padding-top:20px}
    .demo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
    .demo-btn{padding:8px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--muted);cursor:pointer;font-size:12px;text-align:center;transition:all .2s}
    .demo-btn:hover{background:rgba(255,255,255,.1);color:var(--text);border-color:rgba(255,255,255,.2)}
    
    /* Toast */
    .toast{position:fixed;right:20px;bottom:20px;padding:12px 16px;background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:12px;box-shadow:var(--shadow);display:none;z-index:1001;max-width:300px;animation:toastSlideIn .3s ease}
    @keyframes toastSlideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-color:var(--ok)}
    .toast.error{border-color:var(--danger)}
    .toast.warning{border-color:var(--warn)}
    
    /* Dashboard */
    .dashboard{display:none;min-height:100vh}
    .dashboard.active{display:block}
    .dashboard-header{background:var(--card);border-bottom:1px solid rgba(255,255,255,.1);padding:20px 0}
    .dashboard-nav{display:flex;justify-content:space-between;align-items:center}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;color:white;font-weight:700}
    .logout-btn{padding:8px 16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--muted);cursor:pointer;font-size:14px;transition:all .2s}
    .logout-btn:hover{background:rgba(255,93,115,.1);border-color:var(--danger);color:var(--danger)}
    .dashboard-content{padding:24px 0}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-bottom:24px}

    /* Payment Modal Styles */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .payment-methods {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .payment-method {
      flex: 1;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }

    .payment-method:hover {
      border-color: var(--primary);
    }

    .payment-method.active {
      border-color: var(--primary);
      background: var(--primary-bg);
    }

    .payment-method input[type="radio"] {
      display: none;
    }

    .method-info {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .method-icon {
      font-size: 20px;
    }

    .contract-document {
      background: white;
      color: #333;
      padding: 40px;
      font-family: 'Times New Roman', serif;
      line-height: 1.6;
    }

    .contract-header h2 {
      color: #000;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .contract-section {
      margin-bottom: 30px;
    }

    .contract-section h3 {
      color: #000;
      font-weight: bold;
      text-transform: uppercase;
      margin-bottom: 15px;
      border-bottom: 2px solid #000;
      padding-bottom: 5px;
    }

    .contract-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    .contract-table td {
      padding: 8px 12px;
      border: 1px solid #ddd;
    }

    .contract-table td:first-child {
      background: #f5f5f5;
      width: 30%;
    }

    .signature-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 30px;
    }

    .signature-block {
      text-align: center;
    }

    .digital-signature {
      margin-top: 20px;
    }

    .signature-stamp {
      border: 3px solid #000;
      padding: 20px;
      background: #f0f8ff;
      font-weight: bold;
      text-transform: uppercase;
      display: inline-block;
      transform: rotate(-5deg);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }

    .contract-footer {
      margin-top: 40px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }

    #credit-card-form {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .stat-card{background:linear-gradient(135deg,var(--card) 0%,rgba(18,24,49,.8) 100%);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:20px;text-align:center}
    .stat-value{font-size:32px;font-weight:800;margin-bottom:8px}
    .stat-label{color:var(--muted);font-size:14px}
    
    /* Tables */
    .data-table{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);overflow:hidden}
    .table-header{background:rgba(255,255,255,.05);padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;justify-content:space-between;align-items:center}
    .table-filters{display:flex;gap:12px;align-items:center}
    .filter-select,.filter-input{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
    th{color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:.5px}
    .status{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
    .status.success{background:rgba(25,195,125,.2);color:var(--ok)}
    .status.warning{background:rgba(255,176,32,.2);color:var(--warn)}
    .status.danger{background:rgba(255,85,115,.2);color:var(--danger)}
    .action-btn{padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:var(--text);cursor:pointer;font-size:12px;margin-right:4px}
    .action-btn:hover{background:rgba(255,255,255,.1)}
    
    /* User Dashboard Tabs */
    .user-nav{background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.1);padding:0}
    .nav-tabs{display:flex;gap:0;overflow-x:auto}
    .nav-tab{padding:16px 24px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;border-bottom:3px solid transparent;white-space:nowrap}
    .nav-tab:hover{color:var(--text);background:rgba(255,255,255,.05)}
    .nav-tab.active{color:var(--brand);border-bottom-color:var(--brand);background:rgba(79,140,255,.1)}
    
    /* Tab Content */
    .tab-content{display:none;padding-top:24px}
    .tab-content.active{display:block}
    
    /* Station Posts Selection */
    .post-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px}
    .post-item{padding:12px;border:1px solid rgba(255,255,255,.1);border-radius:8px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.02)}
    .post-item:hover{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .post-item.selected{border-color:var(--brand);background:var(--brand);color:#061023}
    .post-item.occupied{border-color:var(--danger);background:rgba(255,85,115,.1);color:var(--danger);cursor:not-allowed}

    /* Slot Grid */
    .slot-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:8px}
    .slot-item{padding:6px 2px;border:1px solid rgba(255,255,255,.1);border-radius:6px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.02);font-size:11px}
    .slot-item:hover{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .slot-item.selected{border-color:var(--brand);background:var(--brand);color:#061023}
    .slot-item.has-battery{border-color:var(--ok);background:rgba(25,195,125,.1);color:var(--ok)}
    .slot-item.empty{border-color:var(--muted);background:rgba(255,255,255,.05);color:var(--muted)}
    .slot-item.charging{border-color:var(--warn);background:rgba(255,176,32,.1);color:var(--warn)}
    .slot-item.maintenance{border-color:var(--danger);background:rgba(255,85,115,.1);color:var(--danger);cursor:not-allowed}
    
    /* Station List Items */
    .station-item{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer;transition:all .2s}
    .station-item:hover{background:rgba(255,255,255,.05)}
    .station-item:last-child{border-bottom:none}
    
    /* Payment Method Icons */
    .payment-method{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;transition:all .2s}
    .payment-method:hover{background:rgba(255,255,255,.05)}
    
    /* Top-up Amount Display */
    .amount-display{font-size:18px;font-weight:600;color:var(--brand);text-align:center;margin:8px 0}
    
    /* Map Container in User Dashboard */
    #user-map{border:1px solid rgba(255,255,255,.1)}
    
    /* Battery Health Management Styles */
    .battery-health-dashboard{max-width:1200px;margin:0 auto}
    .vehicle-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}
    .vehicle-card{background:var(--card);border:2px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:20px;transition:all .3s ease;cursor:pointer}
    .vehicle-card:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:var(--shadow)}
    .vehicle-card.selected{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .vehicle-info h4{color:var(--text);margin-bottom:8px}
    .vehicle-info p{color:var(--muted);margin-bottom:15px}
    .battery-preview{margin:15px 0}
    .charge-level{margin-bottom:10px}
    .charge-percent{font-size:1.2rem;font-weight:600;color:var(--text)}
    .charge-bar{width:100%;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:5px}
    .charge-fill{height:100%;background:linear-gradient(90deg,#4CAF50 0%,#8BC34A 50%,#CDDC39 100%);transition:width .3s ease}
    .health-indicator{margin-top:10px}
    .health-percent{font-weight:600;padding:4px 8px;border-radius:6px;font-size:.9rem}
    .health-percent.excellent{background:#4CAF50;color:white}
    .health-percent.good{background:#8BC34A;color:white}
    .health-percent.fair{background:#FF9800;color:white}
    .health-percent.poor{background:#F44336;color:white}
    .detailed-battery-view{margin-top:30px}
    .vehicle-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,.1)}
    .last-updated{color:var(--muted);font-size:.9rem}
    .battery-metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:25px;margin-bottom:30px}
    .metric-card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:25px}
    .metric-card h4{color:var(--text);margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .large-charge-display{text-align:center}
    .charge-circle{position:relative;width:150px;height:150px;margin:0 auto 20px}
    .charge-circle svg{width:100%;height:100%;transform:rotate(-90deg)}
    .charge-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .charge-number{font-size:2.5rem;font-weight:700;color:var(--text)}
    .charge-unit{font-size:1.2rem;color:var(--muted)}
    .range-estimate{color:var(--muted);font-size:.95rem}
    .health-gauge{margin-bottom:20px}
    .health-bar{width:100%;height:20px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;margin-bottom:10px}
    .health-fill{height:100%;border-radius:10px;transition:width .3s ease}
    .health-fill.excellent{background:linear-gradient(90deg,#4CAF50,#66BB6A)}
    .health-fill.good{background:linear-gradient(90deg,#8BC34A,#9CCC65)}
    .health-fill.fair{background:linear-gradient(90deg,#FF9800,#FFB74D)}
    .health-fill.poor{background:linear-gradient(90deg,#F44336,#EF5350)}
    .health-value{text-align:center}
    .health-number{font-size:1.8rem;font-weight:600;color:var(--text)}
    .health-label{display:block;color:var(--muted);font-size:.9rem;margin-top:5px}
    .health-details{border-top:1px solid rgba(255,255,255,.1);padding-top:15px}
    .detail-item{display:flex;justify-content:space-between;margin-bottom:8px}
    .detail-item span{color:var(--muted)}
    .detail-item strong{color:var(--text)}
    .info-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(148,163,184,.1)}
    .info-item:last-child{border-bottom:none}
    .info-label{color:var(--muted);font-size:.9rem}
    .info-value{color:var(--text);font-weight:500}
    .chart-section{margin:30px 0;background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:25px}
    .chart-section h4{margin-bottom:20px}
    .chart-container{background:rgba(255,255,255,.02);border-radius:8px;padding:20px}
    .simple-chart{display:flex;align-items:stretch;height:220px}
    .chart-y-axis{display:flex;flex-direction:column;justify-content:space-between;padding-right:10px;font-size:.8rem;color:var(--muted);width:40px}
    .chart-area{flex:1;background:linear-gradient(to bottom,rgba(76,175,80,.1) 0%,rgba(76,175,80,.05) 100%);border-radius:4px;margin:0 10px}
    .chart-svg{width:100%;height:100%}
    .chart-x-axis{display:flex;justify-content:space-between;margin-top:10px;font-size:.8rem;color:var(--muted)}
    .recommendations-section{margin:30px 0}
    .recommendations-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px}
    .recommendation-card{display:flex;align-items:center;gap:15px;padding:15px;border-radius:8px;border-left:4px solid}
    .recommendation-card.success{background:rgba(76,175,80,.1);border-left-color:#4CAF50}
    .recommendation-card.warning{background:rgba(255,152,0,.1);border-left-color:#FF9800}
    .recommendation-card.info{background:rgba(33,150,243,.1);border-left-color:#2196F3}
    .rec-icon{font-size:1.5rem;flex-shrink:0}
    .rec-content h5{color:var(--text);margin-bottom:5px;font-size:.95rem}
    .rec-content p{color:var(--muted);font-size:.85rem;margin:0;line-height:1.4}
    .export-section{text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid rgba(255,255,255,.1)}
    .loading-message{text-align:center;padding:60px 20px;color:var(--muted)}
    .loading-spinner{font-size:2rem;margin-bottom:15px;animation:spin 2s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    /* Plan Selection Modal */
    .plan-selection-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}
    .plan-selection-content{background:var(--card);border-radius:var(--radius);padding:30px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto}
    .plan-selection-header{text-align:center;margin-bottom:30px}
    .plan-selection-header h2{color:var(--text);margin-bottom:10px}
    .plan-selection-header p{color:var(--muted);margin-bottom:0}
    .plans-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-bottom:30px}
    .plan-option{background:rgba(255,255,255,.03);border:3px solid rgba(255,255,255,.1);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all .3s ease;position:relative}
    .plan-option:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.3)}
    .plan-option.selected{border-color:var(--brand);box-shadow:0 0 20px rgba(79,140,255,.3)}
    .plan-header{background:linear-gradient(135deg,var(--brand) 0%,var(--brand-hover) 100%);color:white;padding:20px;text-align:center}
    .plan-icon{font-size:2.5rem;display:block;margin-bottom:10px}
    .plan-header h3{margin:0 0 8px 0;font-size:1.4rem;font-weight:600}
    .plan-price{font-size:1.1rem;font-weight:500;opacity:.9}
    .plan-features{padding:20px}
    .plan-features h4{color:var(--text);margin:0 0 12px 0;font-size:1rem;font-weight:600}
    .plan-features ul{list-style:none;padding:0;margin:0 0 20px 0}
    .plan-features li{color:var(--muted);padding:4px 0;font-size:.9rem}
    .plan-vehicles{display:flex;flex-direction:column;gap:8px}
    .vehicle-preview{display:flex;align-items:center;gap:10px;padding:8px;background:rgba(255,255,255,.05);border-radius:6px}
    .vehicle-preview span{font-size:1.5rem}
    .vehicle-preview strong{color:var(--text);font-size:.9rem}
    .vehicle-preview small{color:var(--muted);font-size:.8rem}
    .selected-plan-info{margin-top:15px}
    .plan-badge{display:inline-block;padding:8px 16px;border-radius:20px;color:white;font-weight:500;font-size:.9rem}
    
    /* Vehicle Selection Modal */
    .vehicle-selection-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}
    .vehicle-selection-content{background:var(--card);border-radius:var(--radius);padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
    .vehicle-selection-header{text-align:center;margin-bottom:30px}
    .vehicle-selection-header h2{color:var(--text);margin-bottom:10px}
    .vehicle-selection-header p{color:var(--muted);margin-bottom:0}
    .vehicles-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px}
    .vehicle-option{background:rgba(255,255,255,.03);border:2px solid rgba(255,255,255,.1);border-radius:var(--radius-sm);padding:20px;cursor:pointer;transition:all .3s ease;text-align:center}
    .vehicle-option:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:var(--shadow)}
    .vehicle-option.selected{border-color:var(--brand);background:rgba(79,140,255,.1)}
    .vehicle-icon{font-size:3rem;margin-bottom:15px;display:block}
    .vehicle-name{font-size:1.2rem;font-weight:600;color:var(--text);margin-bottom:8px}
    .vehicle-details{color:var(--muted);font-size:.9rem;line-height:1.4}
    .vehicle-battery{margin-top:12px;padding:8px 12px;background:rgba(76,175,80,.1);border-radius:6px;color:#4CAF50;font-weight:500}
    .modal-actions{display:flex;gap:15px;justify-content:center;margin-top:25px}
    
    /* Settings Styles */
    .settings-section{margin-bottom:30px;background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:24px}
    .settings-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,.1)}
    .setting-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .setting-item:last-child{border-bottom:none}
    .setting-label{flex:1}
    .setting-control{display:flex;align-items:center;gap:12px}
    .toggle-switch{position:relative;width:50px;height:24px;background:rgba(255,255,255,.1);border-radius:12px;cursor:pointer;transition:all .3s}
    .toggle-switch.active{background:var(--brand)}
    .toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:white;border-radius:50%;transition:all .3s}
    .toggle-switch.active::after{left:28px}
    .notification-item{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:16px;margin-bottom:12px}
    .notification-time{color:var(--muted);font-size:12px;margin-bottom:4px}
    .notification-content{color:var(--text);font-size:14px}
    .notification-actions{margin-top:8px;display:flex;gap:8px}
    .notification-btn{padding:4px 12px;font-size:12px;border-radius:6px}
    
    /* Manual Battery Swap Styles */
    .manual-swap-container{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:24px;margin-bottom:24px}
    .swap-request-item{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
    .request-info{flex:1}
    .request-actions{display:flex;gap:8px}
    .priority-high{border-left:4px solid var(--danger)}
    .priority-medium{border-left:4px solid var(--warn)}
    .priority-low{border-left:4px solid var(--ok)}
    .confirmation-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000}
    .confirmation-content{background:var(--card);border-radius:var(--radius);padding:30px;max-width:500px;width:90%}
    .confirmation-steps{margin:20px 0}
    .step-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,.02)}
    .step-number{width:24px;height:24px;border-radius:50%;background:var(--brand);color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}
    .step-completed{background:var(--ok)}
    
    /* PDF Report Styles */
    .report-scheduler{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:24px;margin-bottom:24px}
    .schedule-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,.02);border-radius:8px;margin-bottom:8px}
    .schedule-info{flex:1}
    .schedule-status{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
    .schedule-status.active{background:rgba(25,195,125,.2);color:var(--ok)}
    .schedule-status.inactive{background:rgba(255,85,115,.2);color:var(--danger)}
    .email-preview{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:16px;margin-top:16px;font-family:monospace;font-size:12px}

    /* Responsive for User Dashboard */
    @media (max-width:768px){
      .nav-tabs{flex-direction:column}
      .nav-tab{text-align:center;border-bottom:1px solid rgba(255,255,255,.1);border-left:3px solid transparent}
      .nav-tab.active{border-left-color:var(--brand);border-bottom-color:transparent}
    }
    
    /* Responsive */
    @media (max-width:1024px){
      #features .grid{grid-template-columns:repeat(2,1fr)}
      .pricing{grid-template-columns:1fr}
      .stations{grid-template-columns:repeat(2,1fr)}
      .contact-grid{grid-template-columns:1fr}
      .footer-grid{grid-template-columns:1fr;text-align:center}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:768px){
      .nav{flex-wrap:wrap;height:auto;padding:12px 0}
      .nav-links{order:3;width:100%;justify-content:center;margin-top:12px}
      .title{font-size:34px}
      #features .grid{grid-template-columns:1fr}
      .stations{grid-template-columns:1fr}
      .form-row{grid-template-columns:1fr}
      .demo-grid{grid-template-columns:1fr}
      .form-actions{flex-direction:column}
      .stats-grid{grid-template-columns:1fr}
      .table-filters{flex-direction:column;align-items:stretch}
      .dashboard-nav{flex-direction:column;gap:16px;text-align:center}
    }
    
    /* Payment Sub-Tabs */
    .payment-container { padding: 20px 0; }
    .payment-sub-nav {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    .payment-sub-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      font-size: 14px;
    }
    .payment-sub-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }
    .payment-sub-content {
      display: none;
      padding: 20px 0;
    }
    .payment-sub-content.active {
      display: block;
    }
    
    /* Payment Methods */
    .payment-method-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .payment-method {
      background: var(--card);
      border: 2px solid rgba(255,255,255,.1);
      border-radius: var(--radius-sm);
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .payment-method:hover {
      border-color: var(--brand);
    }
    .payment-method.selected {
      border-color: var(--brand);
      background: rgba(79,140,255,.1);
    }
    .method-icon {
      font-size: 24px;
    }
    .method-info h6 {
      margin: 0 0 4px 0;
      color: var(--text);
    }
    .method-info p {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
    }
    .payment-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    
    /* Auto Pay Styles */
    .autopay-toggle {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: var(--card);
      border-radius: var(--radius);
      margin-bottom: 20px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
    }
    input:checked + .slider {
      background-color: var(--brand);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .slider.round {
      border-radius: 34px;
    }
    .slider.round:before {
      border-radius: 50%;
    }
    .autopay-settings {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .setting-group {
      margin-bottom: 20px;
    }
    .setting-group h5 {
      margin-bottom: 10px;
      color: var(--text);
    }
    .autopay-method-selection {
      display: flex;
      gap: 15px;
    }
    .autopay-method {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      background: rgba(255,255,255,.05);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .autopay-method:hover {
      background: rgba(255,255,255,.1);
    }
    .notification-settings {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
      cursor: pointer;
    }
    .autopay-record {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--card);
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .record-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .record-date {
      font-weight: 500;
      color: var(--text);
    }
    .record-amount {
      color: var(--muted);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
        </div>
        SWP201
      </div>
      <nav class="nav-links">
        <a href="#features">Tính năng</a>
        <a href="#pricing">Bảng giá</a>
        <a href="#stations">Trạm</a>
        <a href="#contact">Liên hệ</a>
      </nav>
      <div class="auth-buttons">
        <button class="btn" onclick="showLogin()">Đăng nhập</button>
        <button class="btn btn-primary" onclick="showRegister()">Đăng ký</button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="container">
        <div class="eyebrow">SWP201 • Đổi pin trong 3 phút • Thanh toán thông minh • Quản lý tự động</div>
        <h1 class="title">SWP201: Hệ thống <strong>đổi pin xe điện</strong> thông minh</h1>
        <p class="subtitle">Nền tảng quản lý toàn diện cho người dùng, nhân viên và quản trị viên. Tích hợp bản đồ, thanh toán và theo dõi real-time.</p>
        <div class="hero-actions">
          <button class="btn btn-primary" onclick="showLogin()">Truy cập hệ thống</button>
          <button class="btn" onclick="scrollToId('stations')">Xem bản đồ trạm</button>
        </div>
      </div>
    </section>

    <section id="features">
      <div class="container">
        <h2>Tính năng hệ thống</h2>
        <div class="grid">
          <div class="card">
            <div class="icon">👤</div>
            <h3>Dashboard người dùng</h3>
            <p class="muted">Theo dõi lịch sử đổi pin, thanh toán, tìm trạm gần nhất và đặt lịch online.</p>
          </div>
          <div class="card">
            <div class="icon">👨‍ </div>
            <h3>Dashboard nhân viên</h3>
            <p class="muted">Quản lý trạm, theo dõi tình trạng pin, xử lý yêu cầu khách hàng.</p>
          </div>
          <div class="card">
            <div class="icon">⚙️</div>
            <h3>Dashboard quản trị</h3>
            <p class="muted">Thống kê toàn hệ thống, quản lý người dùng, cấu hình và báo cáo.</p>
          </div>
          <div class="card">
            <div class="icon"> ️</div>
            <h3>Bản đồ tương tác</h3>
            <p class="muted">Tìm trạm theo vị trí, xem tình trạng real-time, điều hướng GPS.</p>
          </div>
          <div class="card">
            <div class="icon">💳</div>
            <h3>Thanh toán thông minh</h3>
            <p class="muted">Nhiều phương thức thanh toán, lọc giao dịch, xuất báo cáo chi tiết.</p>
          </div>
          <div class="card">
            <div class="icon">🔋</div>
            <h3>Quản lý pin</h3>
            <p class="muted">Theo dõi tình trạng pin, lịch bảo trì, tối ưu hóa hiệu suất.</p>
          </div>
        </div>
      </div>
    </section>

    <section id="pricing">
      <div class="container">
        <h2>Gói dịch vụ</h2>
        <div class="pricing">
          <div class="card">
            <h3>Cơ bản</h3>
            <div class="price">89.000đ/lượt</div>
            <ul class="clean">
              <li><span class="tick">✓</span> Đổi pin tiêu chuẩn</li>
              <li><span class="tick">✓</span> App mobile</li>
              <li><span class="tick">✓</span> Thanh toán QR</li>
            </ul>
            <button class="btn btn-primary" onclick="showLogin()">Đăng ký ngay</button>
          </div>
          <div class="card featured">
            <h3>Premium <span class="chip">Phổ biến</span></h3>
            <div class="price">299.000đ/tháng</div>
            <ul class="clean">
              <li><span class="tick">✓</span> 8 lượt/tháng</li>
              <li><span class="tick">✓</span> Ưu tiên tại trạm</li>
              <li><span class="tick">✓</span> Hỗ trợ 24/7</li>
              <li><span class="tick">✓</span> Báo cáo chi tiết</li>
            </ul>
            <button class="btn btn-primary" onclick="showLogin()">Chọn gói</button>
          </div>
          <div class="card">
            <h3>Doanh nghiệp</h3>
            <div class="price">Liên hệ</div>
            <ul class="clean">
              <li><span class="tick">✓</span> Không giới hạn</li>
              <li><span class="tick">✓</span> API tích hợp</li>
              <li><span class="tick">✓</span> Dashboard quản lý</li>
              <li><span class="tick">✓</span> SLA 99.9%</li>
            </ul>
            <button class="btn" onclick="showContact()">Tư vấn</button>
          </div>
        </div>
      </div>
    </section>

    <section id="stations">
      <div class="container">
        <h2>Bản đồ trạm đổi pin</h2>
        <div class="map-container">
          <div id="map" style="height: 400px; border-radius: 12px; overflow: hidden;"></div>
        </div>
        <div class="station-info">
          <div class="grid stations">
            <div class="card" id="selected-station">
              <h3>Chọn trạm trên bản đồ</h3>
              <p class="muted">Click vào các marker để xem thông tin chi tiết trạm.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="contact">
      <div class="container">
        <h2>Liên hệ hỗ trợ</h2>
        <div class="contact-grid">
          <div class="card">
            <h3>📞 Hotline</h3>
            <p>1900 xxxx (24/7)</p>
            <p class="muted">Hỗ trợ khẩn cấp và tư vấn</p>
          </div>
          <div class="card">
            <h3>✉️ Email</h3>
            <p>support@doipin.vn</p>
            <p class="muted">Góp ý và hỗ trợ kỹ thuật</p>
          </div>
          <div class="card">
            <h3>📍 Văn phòng</h3>
            <p>Tầng 10, Tòa nhà FPT</p>
            <p class="muted">TP.HCM & Hà Nội</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Đăng nhập hệ thống</h3>
        <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
      </div>
      <form id="loginForm" onsubmit="return handleLogin(event)">
        <div class="form-group">
          <label for="username">Tên đăng nhập / Email</label>
          <input id="username" type="text" required placeholder="admin@example.com" />
        </div>
        <div class="form-group">
          <label for="password">Mật khẩu</label>
          <input id="password" type="password" required placeholder="••••••••" />
        </div>
        <div class="form-group">
          <label for="userRole">Vai trò</label>
          <select id="userRole" required>
            <option value="">Chọn vai trò</option>
            <option value="user">Người dùng</option>
            <option value="staff">Nhân viên</option>
            <option value="admin">Quản trị viên</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Đăng nhập</button>
          <button type="button" class="btn" onclick="showRegister()">Đăng ký tài khoản</button>
        </div>
      </form>
      <div class="demo-accounts">
        <h4>Tài khoản demo:</h4>
        <div class="demo-grid">
          <button class="demo-btn" onclick="quickLogin('user', 'user@demo.com', '123456')">
            👤 User Demo
          </button>
          <button class="demo-btn" onclick="quickLogin('staff', 'staff@demo.com', '123456')">
            👨‍💼 Staff Demo
          </button>
          <button class="demo-btn" onclick="quickLogin('admin', 'admin@demo.com', '123456')">
            ⚙️ Admin Demo
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Đăng ký tài khoản</h3>
        <button class="close-btn" onclick="closeModal('registerModal')">&times;</button>
      </div>
      <form id="registerForm" onsubmit="return handleRegister(event)">
        <div class="form-row">
          <div class="form-group">
            <label for="regName">Họ và tên</label>
            <input id="regName" type="text" required placeholder="Nguyễn Văn A" />
          </div>
          <div class="form-group">
            <label for="regPhone">Số điện thoại</label>
            <input id="regPhone" type="tel" required placeholder="09xx xxx xxx" />
          </div>
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" required placeholder="example@email.com" />
        </div>
        <div class="form-group">
          <label for="regPassword">Mật khẩu</label>
          <input id="regPassword" type="password" required placeholder="••••••••" />
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Đăng ký</button>
          <button type="button" class="btn" onclick="showLogin()">Đã có tài khoản</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Driver Confirmation Modal -->
  <div id="driver-confirmation-modal" class="confirmation-modal">
    <div class="confirmation-content">
      <div class="modal-header">
        <h3>🚗 Xác nhận đổi pin</h3>
        <button class="close-btn" onclick="closeDriverConfirmation()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="confirmation-info">
          <h4>Thông tin đổi pin</h4>
          <div class="card" style="margin: 16px 0;">
            <div id="swap-details"></div>
          </div>
        </div>
        
        <div class="confirmation-steps">
          <h4>Các bước thực hiện:</h4>
          <div class="step-item">
            <div class="step-number">1</div>
            <div>
              <strong>Xác nhận danh tính</strong><br>
              <span class="muted">Kiểm tra CMND/CCCD và thông tin xe</span>
            </div>
          </div>
          <div class="step-item">
            <div class="step-number">2</div>
            <div>
              <strong>Mở khóa pin cũ</strong><br>
              <span class="muted">Hệ thống sẽ mở khóa pin cần thay</span>
            </div>
          </div>
          <div class="step-item">
            <div class="step-number">3</div>
            <div>
              <strong>Lắp pin mới</strong><br>
              <span class="muted">Lắp pin đã sạc đầy vào xe</span>
            </div>
          </div>
          <div class="step-item">
            <div class="step-number">4</div>
            <div>
              <strong>Xác nhận hoàn thành</strong><br>
              <span class="muted">Kiểm tra và xác nhận đổi pin thành công</span>
            </div>
          </div>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
          <label>
            <input type="checkbox" id="driver-agreement" required>
            Tôi xác nhận đã kiểm tra pin mới và đồng ý với việc đổi pin
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeDriverConfirmation()">Hủy</button>
        <button class="btn btn-success" id="confirm-swap-btn" onclick="confirmDriverSwap()" disabled>
          ✅ Xác nhận đổi pin
        </button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <h4>SWP201</h4>
          <p>Hệ thống đổi pin xe điện thông minh hàng đầu Việt Nam</p>
        </div>
        <div>
          <h4>Liên kết</h4>
          <a href="#features">Tính năng</a>
          <a href="#pricing">Bảng giá</a>
          <a href="#stations">Trạm</a>
        </div>
        <div>
          <h4>Hỗ trợ</h4>
          <a href="#contact">Liên hệ</a>
          <a href="#">Hướng dẫn</a>
          <a href="#">FAQ</a>
        </div>
      </div>
      <div class="footer-bottom">
        © 2025 SWP201 • Hệ thống quản lý thông minh
      </div>
    </div>
  </footer>

  <!-- Payment Modal -->
  <div id="payment-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>💳 Thanh toán gói dịch vụ</h2>
        <span class="close" onclick="closePaymentModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="payment-step-1">
          <div class="card" style="margin-bottom: 20px;">
            <h3 id="selected-plan-info">Gói Premium - 299.000đ/tháng</h3>
            <p class="muted" id="plan-description">8 lượt đổi pin/tháng • Ưu tiên tại trạm • Hỗ trợ 24/7</p>
          </div>
          
          <div class="form-group">
            <label>Thông tin thanh toán</label>
            <div class="payment-methods">
              <label class="payment-method active">
                <input type="radio" name="payment-method" value="credit-card" checked>
                <div class="method-info">
                  <span class="method-icon">💳</span>
                  <span>Thẻ tín dụng/ghi nợ</span>
                </div>
              </label>
              <label class="payment-method">
                <input type="radio" name="payment-method" value="bank-transfer">
                <div class="method-info">
                  <span class="method-icon">🏦</span>
                  <span>Chuyển khoản ngân hàng</span>
                </div>
              </label>
            </div>
          </div>

          <div id="credit-card-form">
            <div class="form-group">
              <label>Số thẻ *</label>
              <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
            </div>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label>Tháng/Năm *</label>
                <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5">
              </div>
              <div class="form-group">
                <label>CVV *</label>
                <input type="text" id="card-cvv" placeholder="123" maxlength="3">
              </div>
            </div>
            
            <div class="form-group">
              <label>Tên chủ thẻ *</label>
              <input type="text" id="card-holder" placeholder="NGUYEN VAN A">
            </div>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="agree-terms" required>
              Tôi đồng ý với <a href="#" onclick="showContract()">điều khoản dịch vụ</a> và <a href="#" onclick="showContract()">chính sách bảo mật</a>
            </label>
          </div>
        </div>

        <div id="payment-step-2" style="display: none;">
          <div class="text-center">
            <div class="loading-spinner" style="margin: 20px auto;"></div>
            <h3>Đang xử lý thanh toán...</h3>
            <p class="muted">Vui lòng không đóng cửa sổ này</p>
          </div>
        </div>

        <div id="payment-step-3" style="display: none;">
          <div class="text-center">
            <div style="font-size: 48px; color: var(--success); margin: 20px 0;">✅</div>
            <h3>Thanh toán thành công!</h3>
            <p class="muted">Gói dịch vụ đã được kích hoạt</p>
            <button class="btn btn-primary" onclick="showContract()">Xem hợp đồng điện tử</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closePaymentModal()">Hủy</button>
        <button class="btn btn-primary" id="payment-btn" onclick="processPayment()">Thanh toán ngay</button>
      </div>
    </div>
  </div>

  <!-- Contract Modal -->
  <div id="contract-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>📄 Hợp đồng điện tử</h2>
        <span class="close" onclick="closeContractModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="contract-content">
          <!-- Contract will be generated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="downloadContract()">📥 Tải xuống PDF</button>
        <button class="btn btn-primary" onclick="closeContractModal()">Đóng</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>
    // Authentication System
    class AuthSystem {
      constructor() {
        this.currentUser = null;
        this.selectedPlanId = null;
        this.selectedPlan = null;
        this.selectedVehicleId = null;
        this.init();
      }

      init() {
        // Disable auto-login to prevent plan selection modal on page load
        // User must manually click login button
        
        // const savedUser = localStorage.getItem('currentUser');
        // if (savedUser) {
        //   this.currentUser = JSON.parse(savedUser);
        //   this.showDashboard();
        // }
      }

      login(username, password, role) {
        const demoUsers = {
          'user@demo.com': { role: 'user', name: 'Nguyễn Văn User', password: '123456' },
          'staff@demo.com': { role: 'staff', name: 'Trần Thị Staff', password: '123456' },
          'admin@demo.com': { role: 'admin', name: 'Lê Văn Admin', password: '123456' }
        };

        const user = demoUsers[username];
        if (user && user.password === password && user.role === role) {
          this.currentUser = {
            username,
            name: user.name,
            role: user.role,
            loginTime: new Date().toISOString()
          };
          localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
          this.showDashboard();
          return true;
        }
        return false;
      }

      logout() {
        this.currentUser = null;
        localStorage.removeItem('currentUser');
        this.showLandingPage();
        showToast('Đã đăng xuất thành công', 'success');
      }

      showDashboard() {
        if (!this.currentUser) return;

        // For users, check if they need to select plan/vehicle first
        if (this.currentUser.role === 'user') {
          // Only show plan selection if no plan is selected
          if (!this.currentUser.selectedPlan) {
            this.showPlanSelection();
            return;
          }
          
          // Only show vehicle selection if no vehicle is selected
          if (!this.currentUser.selectedVehicle) {
            this.showVehicleSelection();
            return;
          }
          
          // Both plan and vehicle are selected, proceed to dashboard
        }

        // Hide main content
        document.querySelector('main').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        document.querySelector('footer').style.display = 'none';

        const role = this.currentUser.role;
        let dashboardId = role + 'Dashboard';
        
        // Create dashboard if it doesn't exist
        if (!document.getElementById(dashboardId)) {
          console.log('Creating dashboard for role:', role);
          this.createDashboard(role);
        }

        // Hide all dashboards first
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        
        // Show the correct dashboard
        const targetDashboard = document.getElementById(dashboardId);
        if (targetDashboard) {
          targetDashboard.classList.add('active');
          console.log('Dashboard activated:', dashboardId);
          showToast(`Chào mừng ${this.currentUser.name}!`, 'success');
        } else {
          console.error('Dashboard not found:', dashboardId);
          showToast('Lỗi: Không thể tải dashboard', 'error');
        }
      }

      showLandingPage() {
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        document.querySelector('main').style.display = 'block';
        document.querySelector('header').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
      }

      createDashboard(role) {
        const dashboardHtml = this.getDashboardHtml(role);
        document.body.insertAdjacentHTML('beforeend', dashboardHtml);
      }

      getDashboardHtml(role) {
        const dashboards = {
          user: this.getUserDashboardHtml(),
          staff: this.getStaffDashboardHtml(),
          admin: this.getAdminDashboardHtml()
        };
        return dashboards[role];
      }

      getUserDashboardHtml() {
        return `
          <div id="userDashboard" class="dashboard">
            <div class="dashboard-header">
              <div class="container">
                <div class="dashboard-nav">
                  <div class="brand">
                    <div class="logo">
                      <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
                    </div>
                    Dashboard Người Dùng
                  </div>
                  <div class="user-info">
                    <div class="user-avatar">${this.currentUser.name.charAt(0)}</div>
                    <div>
                      <div>${this.currentUser.name}</div>
                      <div class="muted">
                        ${this.currentUser.selectedVehicle ? 
                          `${this.currentUser.selectedVehicle.icon} ${this.currentUser.selectedVehicle.name}` : 
                          'Người dùng'
                        }
                      </div>
                    </div>
                    <div class="vehicle-quick-info" style="margin: 0 15px; text-align: right;">
                      ${this.currentUser.selectedVehicle ? `
                        <div style="color: var(--brand); font-weight: 600;">${this.currentUser.selectedVehicle.currentCharge}%</div>
                        <div style="color: var(--muted); font-size: 0.8rem;">Pin hiện tại</div>
                      ` : ''}
                    </div>
                    <button class="logout-btn" onclick="auth.logout()">Đăng xuất</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- User Dashboard Navigation -->
            <div class="user-nav">
              <div class="container">
                <div class="nav-tabs">
                  <button class="nav-tab active" onclick="showUserTab('overview')">📊 Tổng quan</button>
                  <button class="nav-tab" onclick="showUserTab('battery-swap')">🔋 Đổi pin ngay</button>
                  <button class="nav-tab" onclick="showUserTab('battery-health')">💊 Tình trạng pin</button>
                  <button class="nav-tab" onclick="showUserTab('payment-history')">💳 Thanh toán</button>
                  <button class="nav-tab" onclick="showUserTab('plans')">📦 Gói dịch vụ</button>
                  <button class="nav-tab" onclick="showUserTab('map')">🗺️ Bản đồ trạm</button>
                  <button class="nav-tab" onclick="showUserTab('settings')">⚙️ Cài đặt</button>
                </div>
              </div>
            </div>

            <div class="dashboard-content">
              <div class="container">
                
                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                  <div class="stats-grid">
                    <div class="stat-card">
                      <div class="stat-value">12</div>
                      <div class="stat-label">Lượt đổi pin</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">1,240,000đ</div>
                      <div class="stat-label">Tổng chi phí</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">Premium</div>
                      <div class="stat-label">Gói hiện tại</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value">4.8★</div>
                      <div class="stat-label">Đánh giá của bạn</div>
                    </div>
                  </div>

                  <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                    <div class="data-table">
                      <div class="table-header">
                        <h3>Hoạt động gần đây</h3>
                      </div>
                      <table>
                        <thead>
                          <tr>
                            <th>Thời gian</th>
                            <th>Hoạt động</th>
                            <th>Trạng thái</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>15/10/2025 14:30</td>
                            <td>Đổi pin tại Trạm Bùi Thị Xuân</td>
                            <td><span class="status success">Hoàn thành</span></td>
                          </tr>
                          <tr>
                            <td>14/10/2025 10:20</td>
                            <td>Nạp tiền vào tài khoản</td>
                            <td><span class="status success">Thành công</span></td>
                          </tr>
                          <tr>
                            <td>12/10/2025 09:15</td>
                            <td>Đổi pin tại Trạm Cầu Giấy</td>
                            <td><span class="status success">Hoàn thành</span></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <div class="card">
                      <h3>Gói dịch vụ hiện tại</h3>
                      <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--brand);">Premium</div>
                        <div class="muted">299,000đ/tháng</div>
                        <div style="margin: 16px 0;">
                          <div style="background: rgba(79,140,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: var(--brand); height: 100%; width: 60%; border-radius: 4px;"></div>
                          </div>
                          <div class="muted" style="margin-top: 8px;">4/8 lượt đã sử dụng</div>
                        </div>
                      </div>
                      <button class="btn btn-primary" style="width: 100%;" onclick="showUserTab('plans')">Xem gói khác</button>
                    </div>
                  </div>
                </div>

                <!-- Battery Swap Tab -->
                <div id="battery-swap-tab" class="tab-content">
                  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="card">
                      <h3>🔋 Đổi pin ngay</h3>
                      <p class="muted">Chọn trạm và trụ để đổi pin tự động qua hệ thống IoT</p>
                      
                      <div class="form-group">
                        <label>🏢 Chọn trạm đổi pin</label>
                        <select id="station-select" required onchange="loadStationPosts()">
                          <option value="">Chọn trạm đổi pin</option>
                          <option value="station1">Trạm Bùi Thị Xuân (8 pin sẵn sàng)</option>
                          <option value="station2">Trạm Cầu Giấy (12 pin sẵn sàng)</option>
                          <option value="station3">Trạm Thủ Đức (15 pin sẵn sàng)</option>
                          <option value="station4">Trạm Hải Châu (6 pin sẵn sàng)</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label>🔌 Chọn trụ đổi pin</label>
                        <div id="post-grid" style="display: none;">
                          <div class="post-grid" id="posts-container">
                            <!-- Posts will be loaded here -->
                          </div>
                        </div>
                        <div id="no-station" class="muted" style="text-align: center; padding: 20px;">
                          Vui lòng chọn trạm để xem các trụ đổi pin
                        </div>
                      </div>

                      <div class="form-group" id="selected-post-info" style="display: none;">
                        <div style="background: rgba(79,140,255,0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(79,140,255,0.3);">
                          <h4 style="margin: 0 0 8px 0; color: var(--brand);">📍 Trụ đã chọn</h4>
                          <div id="post-details"></div>
                          
                          <!-- Slot selection -->
                          <div id="slot-selection" style="margin-top: 16px;">
                            <h5 style="margin: 0 0 8px 0;">Chọn slot để lấy pin:</h5>
                            <div id="available-slots" class="slot-grid"></div>
                            
                            <h5 style="margin: 16px 0 8px 0;">Chọn slot để trả pin cũ:</h5>
                            <div id="empty-slots" class="slot-grid"></div>
                          </div>
                        </div>
                      </div>

                      <div class="form-group" id="plan-status">
                        <div style="background: rgba(25,195,125,0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(25,195,125,0.3);">
                          <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                              <span>  Gói Premium:</span><br>
                              <span class="muted">Còn lại 4/8 lượt tháng này</span>
                            </div>
                            <span style="font-size: 20px; font-weight: 700; color: var(--ok);">MIỄN PHÍ</span>
                          </div>
                        </div>
                      </div>

                      <button type="button" class="btn btn-primary" style="width: 100%;" onclick="startBatterySwap()" id="swap-btn" disabled>
                        🚀 Bắt đầu đổi pin
                      </button>
                    </div>

                    <div class="card">
                      <h3>  Trạng thái đổi pin</h3>
                      <div id="swap-status" style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">⚡</div>
                        <h4>Sẵn sàng đổi pin</h4>
                        <p class="muted">Chọn trạm và trụ để bắt đầu</p>
                      </div>

                      <div id="swap-progress" style="display: none;">
                        <div style="text-align: center; margin: 20px 0;">
                          <div style="width: 80px; height: 80px; border: 4px solid rgba(79,140,255,0.3); border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                          <style>
                            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                          </style>
                        </div>
                        <div id="progress-text" style="text-align: center;">
                          <h4>Đang kết nối với trụ pin...</h4>
                          <p class="muted">Vui lòng đợi trong giây lát</p>
                        </div>
                      </div>

                      <h3 style="margin-top: 24px;">🕒 Lịch sử đổi pin gần đây</h3>
                      <div style="max-height: 300px; overflow-y: auto;">
                        <table style="font-size: 13px;">
                          <thead>
                            <tr>
                              <th>Ngày</th>
                              <th>Trạm/Trụ</th>
                              <th>Giá</th>
                              <th>Trạng thái</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>15/10 14:30</td>
                              <td>BT Xuân/A2</td>
                              <td>89,000đ</td>
                              <td><span class="status success">Thành công</span></td>
                            </tr>
                            <tr>
                              <td>12/10 09:15</td>
                              <td>Cầu Giấy/B1</td>
                              <td>89,000đ</td>
                              <td><span class="status success">Thành công</span></td>
                            </tr>
                            <tr>
                              <td>08/10 16:45</td>
                              <td>Thủ Đức/C3</td>
                              <td>0đ (Premium)</td>
                              <td><span class="status success">Thành công</span></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Battery Health Tab -->
                <div id="battery-health-tab" class="tab-content">
                  <div id="batteryHealthContent">
                    <div class="loading-message" style="text-align: center; padding: 60px 20px; color: var(--muted);">
                      <div class="loading-spinner" style="font-size: 2rem; margin-bottom: 15px;">🔄</div>
                      <p>Đang tải thông tin pin...</p>
                    </div>
                  </div>
                </div>

                <!-- Payment Tab -->
                <div id="payment-history-tab" class="tab-content">
                  <div class="payment-container">
                    <h3>💳 Quản Lý Thanh Toán</h3>
                    
                    <!-- Payment Sub-Navigation -->
                    <div class="payment-sub-nav">
                      <button class="payment-sub-tab active" onclick="showPaymentSubTab('history')">📜 Lịch sử Payment</button>
                      <button class="payment-sub-tab" onclick="showPaymentSubTab('payment')">💰 Payment</button>
                      <button class="payment-sub-tab" onclick="showPaymentSubTab('autopay')">🔄 Set Autopay</button>
                    </div>

                    <!-- Payment History Sub-Tab -->
                    <div id="payment-history-subtab" class="payment-sub-content active">
                      <div class="data-table">
                        <div class="table-header">
                          <h4>  Lịch sử giao dịch</h4>
                          <div class="table-filters">
                            <select class="filter-select" onchange="filterPaymentHistory()">
                              <option value="all">Tất cả giao dịch</option>
                              <option value="battery-swap">Đổi pin</option>
                              <option value="plan-purchase">Mua gói</option>
                              <option value="top-up">Nạp tiền</option>
                              <option value="refund">Hoàn tiền</option>
                            </select>
                            <select class="filter-select" onchange="filterPaymentHistory()">
                              <option value="all">Tất cả phương thức</option>
                              <option value="credit-card">Thẻ tín dụng</option>
                              <option value="momo">Ví MoMo</option>
                              <option value="zalopay">ZaloPay</option>
                              <option value="bank-transfer">Chuyển khoản</option>
                            </select>
                            <input type="date" class="filter-input" onchange="filterPaymentHistory()">
                          </div>
                        </div>
                        <table>
                          <thead>
                            <tr>
                              <th>Mã GD</th>
                              <th>Thời gian</th>
                              <th>Loại giao dịch</th>
                              <th>Số tiền</th>
                              <th>Phương thức</th>
                              <th>Trạng thái</th>
                              <th>Thao tác</th>
                            </tr>
                          </thead>
                          <tbody id="payment-history-table">
                            <tr>
                              <td>#PAY001</td>
                              <td>15/10/2025 14:35</td>
                              <td>Đổi pin</td>
                              <td>89,000đ</td>
                              <td>Ví MoMo</td>
                              <td><span class="status success">Thành công</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY001')">Chi tiết</button></td>
                            </tr>
                            <tr>
                              <td>#PAY002</td>
                              <td>14/10/2025 10:20</td>
                              <td>Nạp tiền</td>
                              <td>500,000đ</td>
                              <td>Chuyển khoản</td>
                              <td><span class="status success">Thành công</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY002')">Chi tiết</button></td>
                            </tr>
                            <tr>
                              <td>#PAY003</td>
                              <td>12/10/2025 09:20</td>
                              <td>Đổi pin</td>
                              <td>89,000đ</td>
                              <td>ZaloPay</td>
                              <td><span class="status success">Thành công</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY003')">Chi tiết</button></td>
                            </tr>
                            <tr>
                              <td>#PAY004</td>
                              <td>10/10/2025 16:50</td>
                              <td>Mua gói Premium</td>
                              <td id="plan-payment-amount">299,000đ</td>
                              <td>Thẻ tín dụng</td>
                              <td><span class="status success">Thành công</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY004')">Chi tiết</button></td>
                            </tr>
                            <tr>
                              <td>#PAY005</td>
                              <td>08/10/2025 16:50</td>
                              <td>Đổi pin</td>
                              <td>0đ</td>
                              <td>Gói Premium</td>
                              <td><span class="status success">Thành công</span></td>
                              <td><button class="action-btn" onclick="viewPaymentDetail('PAY005')">Chi tiết</button></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Payment Sub-Tab -->
                    <div id="payment-subtab" class="payment-sub-content">
                      <div class="payment-section">
                        <h4>💰 Thanh toán dựa trên gói</h4>
                        <div class="current-plan-payment">
                          <div class="plan-payment-card">
                            <div class="plan-info">
                              <h5 id="current-plan-name">Premium Plan</h5>
                              <p id="current-plan-price">499,000 VNĐ/tháng</p>
                              <p class="plan-features" id="current-plan-features">5 lần đổi pin/ngày • Ưu tiên hỗ trợ • Xe máy điện cao cấp</p>
                            </div>
                            <div class="payment-status">
                              <span class="status success">Đã thanh toán</span>
                              <p class="next-payment">Kỳ tiếp theo: <strong>01/11/2025</strong></p>
                            </div>
                          </div>
                          
                          <div class="payment-methods">
                            <h5>Phương thức thanh toán</h5>
                            <div class="payment-method-grid">
                              <div class="payment-method" onclick="selectPaymentMethod('momo')">
                                <div class="method-icon">📱</div>
                                <div class="method-info">
                                  <h6>Ví MoMo</h6>
                                  <p>Thanh toán nhanh chóng</p>
                                </div>
                                <input type="radio" name="payment-method" value="momo">
                              </div>
                              
                              <div class="payment-method" onclick="selectPaymentMethod('zalopay')">
                                <div class="method-icon">💳</div>
                                <div class="method-info">
                                  <h6>ZaloPay</h6>
                                  <p>Ví điện tử an toàn</p>
                                </div>
                                <input type="radio" name="payment-method" value="zalopay">
                              </div>
                              
                              <div class="payment-method" onclick="selectPaymentMethod('credit-card')">
                                <div class="method-icon">💎</div>
                                <div class="method-info">
                                  <h6>Thẻ tín dụng</h6>
                                  <p>Visa, MasterCard</p>
                                </div>
                                <input type="radio" name="payment-method" value="credit-card">
                              </div>
                              
                              <div class="payment-method" onclick="selectPaymentMethod('bank-transfer')">
                                <div class="method-icon">🏦</div>
                                <div class="method-info">
                                  <h6>Chuyển khoản</h6>
                                  <p>Ngân hàng trực tuyến</p>
                                </div>
                                <input type="radio" name="payment-method" value="bank-transfer">
                              </div>
                            </div>
                            
                            <div class="payment-actions">
                              <button class="btn btn-primary" onclick="processPayment()">💰 Thanh toán ngay</button>
                              <button class="btn" onclick="showPaymentSubTab('autopay')">🔄 Thiết lập tự động</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Auto Pay Sub-Tab -->
                    <div id="autopay-subtab" class="payment-sub-content">
                      <div class="autopay-section">
                        <h4>🔄 Thiết lập thanh toán tự động</h4>
                        
                        <div class="autopay-status">
                          <div class="autopay-toggle">
                            <label class="switch">
                              <input type="checkbox" id="autopay-enabled" onchange="toggleAutoPay()">
                              <span class="slider round"></span>
                            </label>
                            <div class="autopay-info">
                              <h5>Thanh toán tự động</h5>
                              <p id="autopay-status-text">Tắt - Bạn sẽ thanh toán thủ công mỗi tháng</p>
                            </div>
                          </div>
                        </div>

                        <div class="autopay-settings" id="autopay-settings" style="display: none;">
                          <div class="setting-group">
                            <h5>📅 Ngày thanh toán</h5>
                            <select id="autopay-day" onchange="updateAutoPaySettings()">
                              <option value="1">Ngày 1 mỗi tháng</option>
                              <option value="15">Ngày 15 mỗi tháng</option>
                              <option value="end">Cuối tháng</option>
                            </select>
                          </div>

                          <div class="setting-group">
                            <h5>💳 Phương thức thanh toán mặc định</h5>
                            <div class="autopay-method-selection">
                              <div class="autopay-method" onclick="selectAutoPayMethod('momo')">
                                <input type="radio" name="autopay-method" value="momo" checked>
                                <div class="method-icon">📱</div>
                                <span>Ví MoMo</span>
                              </div>
                              <div class="autopay-method" onclick="selectAutoPayMethod('credit-card')">
                                <input type="radio" name="autopay-method" value="credit-card">
                                <div class="method-icon">💎</div>
                                <span>Thẻ tín dụng</span>
                              </div>
                            </div>
                          </div>

                          <div class="setting-group">
                            <h5>📧 Thông báo</h5>
                            <div class="notification-settings">
                              <label class="checkbox-label">
                                <input type="checkbox" checked> Email thông báo trước 3 ngày
                              </label>
                              <label class="checkbox-label">
                                <input type="checkbox" checked> SMS thông báo khi thanh toán thành công
                              </label>
                              <label class="checkbox-label">
                                <input type="checkbox"> Thông báo khi thanh toán thất bại
                              </label>
                            </div>
                          </div>

                          <div class="autopay-actions">
                            <button class="btn btn-primary" onclick="saveAutoPaySettings()">💾 Lưu cài đặt</button>
                            <button class="btn btn-secondary" onclick="testAutoPay()">🧪 Test thanh toán</button>
                          </div>
                        </div>

                        <div class="autopay-history">
                          <h5>📊 Lịch sử thanh toán tự động</h5>
                          <div class="autopay-history-list">
                            <div class="autopay-record">
                              <div class="record-info">
                                <span class="record-date">01/10/2025</span>
                                <span class="record-amount">499,000đ</span>
                              </div>
                              <span class="status success">Thành công</span>
                            </div>
                            <div class="autopay-record">
                              <div class="record-info">
                                <span class="record-date">01/09/2025</span>
                                <span class="record-amount">499,000đ</span>
                              </div>
                              <span class="status success">Thành công</span>
                            </div>
                            <div class="autopay-record">
                              <div class="record-info">
                                <span class="record-date">01/08/2025</span>
                                <span class="record-amount">299,000đ</span>
                              </div>
                              <span class="status success">Thành công</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Plans Tab -->
                <div id="plans-tab" class="tab-content">
                  <h2>📦 Chọn gói dịch vụ phù hợp</h2>
                  <p class="muted">Tiết kiệm chi phí với các gói dịch vụ linh hoạt</p>
                  
                  <div class="pricing">
                    <div class="card">
                      <h3>Cơ bản</h3>
                      <div class="price">89.000đ/lượt</div>
                      <ul class="clean">
                        <li><span class="tick">✓</span> Thanh toán theo lượt</li>
                        <li><span class="tick">✓</span> Không cam kết dài hạn</li>
                        <li><span class="tick">✓</span> Phù hợp sử dụng thỉnh thoảng</li>
                        <li><span class="tick">✓</span> Hỗ trợ qua hotline</li>
                      </ul>
                      <button class="btn" onclick="selectPlan('basic')">Đang sử dụng</button>
                    </div>
                    
                    <div class="card featured">
                      <h3>Premium <span class="chip">Phổ biến</span></h3>
                      <div class="price">299.000đ/tháng</div>
                      <div class="muted">Tiết kiệm 46% so với trả theo lượt</div>
                      <ul class="clean">
                        <li><span class="tick">✓</span> 8 lượt đổi pin/tháng</li>
                        <li><span class="tick">✓</span> Ưu tiên tại trạm</li>
                        <li><span class="tick">✓</span> Hỗ trợ 24/7</li>
                        <li><span class="tick">✓</span> Báo cáo chi tiết</li>
                        <li><span class="tick">✓</span> Miễn phí lượt đầu mỗi ngày</li>
                      </ul>
                      <button class="btn btn-primary" onclick="purchasePlan('premium', 'Gói Premium', 299000, '8 lượt đổi pin/tháng • Ưu tiên tại trạm • Hỗ trợ 24/7')">Mua gói này</button>
                    </div>
                    
                    <div class="card">
                      <h3>Enterprise</h3>
                      <div class="price">899.000đ/tháng</div>
                      <div class="muted">Cho doanh nghiệp vận tải</div>
                      <ul class="clean">
                        <li><span class="tick">✓</span> Không giới hạn lượt đổi</li>
                        <li><span class="tick">✓</span> API tích hợp</li>
                        <li><span class="tick">✓</span> Dashboard quản lý đội xe</li>
                        <li><span class="tick">✓</span> Hỗ trợ kỹ thuật riêng</li>
                        <li><span class="tick">✓</span> Báo cáo tùy chỉnh</li>
                      </ul>
                      <button class="btn btn-primary" onclick="purchasePlan('enterprise', 'Gói Enterprise', 899000, 'Không giới hạn lượt đổi • API tích hợp • Dashboard quản lý đội xe')">Mua gói này</button>
                    </div>
                  </div>

                  <div class="card" style="margin-top: 24px;">
                    <h3>💰 Nạp tiền vào tài khoản</h3>
                    <p class="muted">Nạp trước để thanh toán nhanh chóng hơn</p>
                    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                      <div>
                        <div class="form-group">
                          <label>Số tiền nạp</label>
                          <select id="top-up-amount" onchange="updateTopUpAmount()">
                            <option value="100000">100,000đ</option>
                            <option value="200000">200,000đ (+10,000đ bonus)</option>
                            <option value="500000">500,000đ (+30,000đ bonus)</option>
                            <option value="1000000">1,000,000đ (+80,000đ bonus)</option>
                            <option value="custom">Số tiền khác</option>
                          </select>
                          <input type="number" id="custom-amount" placeholder="Nhập số tiền" style="display: none; margin-top: 8px;" min="50000" step="10000">
                        </div>
                        <div class="form-group">
                          <label>Phương thức thanh toán</label>
                          <select>
                            <option value="momo">Ví MoMo</option>
                            <option value="zalopay">ZaloPay</option>
                            <option value="vnpay">VNPay</option>
                            <option value="bank">Chuyển khoản ngân hàng</option>
                            <option value="credit-card">Thẻ tín dụng/ghi nợ</option>
                          </select>
                        </div>
                      </div>
                      <div>
                        <div style="background: rgba(79,140,255,0.1); padding: 16px; border-radius: 8px; text-align: center;">
                          <div style="font-size: 18px; font-weight: 600;">Số dư hiện tại</div>
                          <div style="font-size: 28px; font-weight: 800; color: var(--brand); margin: 8px 0;">156,000đ</div>
                          <button class="btn btn-primary" onclick="processTopUp()">Nạp tiền</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Map Tab -->
                <div id="map-tab" class="tab-content">
                  <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                    <div class="card">
                      <h3>🗺️ Bản đồ trạm đổi pin</h3>
                      <div id="user-map" style="height: 500px; border-radius: 12px; overflow: hidden; margin-top: 16px;"></div>
                      <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn" onclick="findMyLocation()">📍 Vị trí của tôi</button>
                        <button class="btn" onclick="filterActiveStations()">🟢 Chỉ trạm hoạt động</button>
                        <button class="btn" onclick="showAllStations()">🔄 Hiện tất cả</button>
                      </div>
                    </div>

                    <div>
                      <div class="card" style="margin-bottom: 20px;">
                        <h3>📊 Thông tin trạm đã chọn</h3>
                        <div id="selected-station-info">
                          <p class="muted">Click vào trạm trên bản đồ để xem thông tin chi tiết</p>
                        </div>
                      </div>

                      <div class="card">
                        <h3>🔍 Tìm kiếm trạm</h3>
                        <div class="form-group">
                          <input type="text" placeholder="Tìm theo tên trạm hoặc địa chỉ..." id="station-search" onkeyup="searchStations()">
                        </div>
                        <div class="form-group">
                          <select onchange="filterByDistance()">
                            <option value="all">Tất cả khoảng cách</option>
                            <option value="1">Trong vòng 1km</option>
                            <option value="3">Trong vòng 3km</option>
                            <option value="5">Trong vòng 5km</option>
                            <option value="10">Trong vòng 10km</option>
                          </select>
                        </div>

                        <h4>📋 Danh sách trạm gần</h4>
                        <div id="nearby-stations" style="max-height: 200px; overflow-y: auto;">
                          <div class="station-item" onclick="focusStation('station1')">
                            <strong>Trạm Bùi Thị Xuân</strong><br>
                            <span class="muted">Quận 1, TP.HCM • 0.8km</span><br>
                            <span class="status success">8 pin sẵn sàng</span>
                          </div>
                          <div class="station-item" onclick="focusStation('station2')">
                            <strong>Trạm Cầu Giấy</strong><br>
                            <span class="muted">Cầu Giấy, Hà Nội • 2.1km</span><br>
                            <span class="status success">12 pin sẵn sàng</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                  <h2>⚙️ Cài đặt tài khoản</h2>
                  
                  <!-- Profile Settings -->
                  <div class="settings-section">
                    <div class="settings-header">
                      <h3>👤 Thông tin cá nhân</h3>
                      <button class="btn btn-primary" onclick="editProfile()">Chỉnh sửa</button>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Họ và tên</strong><br>
                        <span class="muted">${this.currentUser.name}</span>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Email</strong><br>
                        <span class="muted">${this.currentUser.username}</span>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Số điện thoại</strong><br>
                        <span class="muted">Chưa cập nhật</span>
                      </div>
                    </div>
                  </div>

                  <!-- Notification Settings -->
                  <div class="settings-section">
                    <div class="settings-header">
                      <h3>🔔 Thông báo</h3>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Thông báo đổi pin</strong><br>
                        <span class="muted">Nhận thông báo khi đổi pin thành công</span>
                      </div>
                      <div class="setting-control">
                        <div class="toggle-switch active" onclick="toggleSetting(this)"></div>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Thông báo thanh toán</strong><br>
                        <span class="muted">Nhận thông báo về giao dịch thanh toán</span>
                      </div>
                      <div class="setting-control">
                        <div class="toggle-switch active" onclick="toggleSetting(this)"></div>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Thông báo khuyến mãi</strong><br>
                        <span class="muted">Nhận thông báo về ưu đãi và khuyến mãi</span>
                      </div>
                      <div class="setting-control">
                        <div class="toggle-switch" onclick="toggleSetting(this)"></div>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Email hàng tuần</strong><br>
                        <span class="muted">Nhận báo cáo sử dụng hàng tuần</span>
                      </div>
                      <div class="setting-control">
                        <div class="toggle-switch active" onclick="toggleSetting(this)"></div>
                      </div>
                    </div>
                  </div>

                  <!-- Security Settings -->
                  <div class="settings-section">
                    <div class="settings-header">
                      <h3>🔒 Bảo mật</h3>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Đổi mật khẩu</strong><br>
                        <span class="muted">Cập nhật mật khẩu đăng nhập</span>
                      </div>
                      <div class="setting-control">
                        <button class="btn" onclick="changePassword()">Đổi mật khẩu</button>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Xác thực 2 bước</strong><br>
                        <span class="muted">Tăng cường bảo mật tài khoản</span>
                      </div>
                      <div class="setting-control">
                        <div class="toggle-switch" onclick="toggleSetting(this)"></div>
                        <button class="btn btn-primary" onclick="setup2FA()">Thiết lập</button>
                      </div>
                    </div>
                  </div>

                  <!-- App Settings -->
                  <div class="settings-section">
                    <div class="settings-header">
                      <h3>📱 Ứng dụng</h3>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Ngôn ngữ</strong><br>
                        <span class="muted">Chọn ngôn ngữ hiển thị</span>
                      </div>
                      <div class="setting-control">
                        <select class="filter-select">
                          <option value="vi">Tiếng Việt</option>
                          <option value="en">English</option>
                        </select>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Chế độ tối</strong><br>
                        <span class="muted">Giao diện tối cho mắt</span>
                      </div>
                      <div class="setting-control">
                        <div class="toggle-switch active" onclick="toggleSetting(this)"></div>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Tự động đồng bộ</strong><br>
                        <span class="muted">Đồng bộ dữ liệu tự động</span>
                      </div>
                      <div class="setting-control">
                        <div class="toggle-switch active" onclick="toggleSetting(this)"></div>
                      </div>
                    </div>
                  </div>

                  <!-- Data & Privacy -->
                  <div class="settings-section">
                    <div class="settings-header">
                      <h3>🛡️ Dữ liệu & Quyền riêng tư</h3>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Xuất dữ liệu</strong><br>
                        <span class="muted">Tải xuống dữ liệu cá nhân</span>
                      </div>
                      <div class="setting-control">
                        <button class="btn" onclick="exportUserData()">Xuất dữ liệu</button>
                      </div>
                    </div>
                    <div class="setting-item">
                      <div class="setting-label">
                        <strong>Xóa tài khoản</strong><br>
                        <span class="muted">Xóa vĩnh viễn tài khoản và dữ liệu</span>
                      </div>
                      <div class="setting-control">
                        <button class="btn btn-danger" onclick="deleteAccount()">Xóa tài khoản</button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        `;
      }

      getStaffDashboardHtml() {
        return `
          <div id="staffDashboard" class="dashboard">
            <div class="dashboard-header">
              <div class="container">
                <div class="dashboard-nav">
                  <div class="brand">
                    <div class="logo">
                      <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
                    </div>
                    Dashboard Nhân Viên
                  </div>
                  <div class="user-info">
                    <div class="user-avatar">${this.currentUser.name.charAt(0)}</div>
                    <div>
                      <div>${this.currentUser.name}</div>
                      <div class="muted">Nhân viên</div>
                    </div>
                    <button class="logout-btn" onclick="auth.logout()">Đăng xuất</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-content">
              <div class="container">
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value">24</div>
                    <div class="stat-label">Pin sẵn sàng</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">6</div>
                    <div class="stat-label">Pin đang sạc</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">18</div>
                    <div class="stat-label">Đổi pin hôm nay</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">95%</div>
                    <div class="stat-label">Hiệu suất trạm</div>
                  </div>
                </div>

                <!-- Manual Battery Swap Section -->
                <div class="manual-swap-container">
                  <h3>🔧 Đổi Pin Thủ Công</h3>
                  <p class="muted">Xử lý yêu cầu đổi pin trực tiếp tại trạm</p>
                  
                  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card">
                      <h4>📋 Thông tin khách hàng</h4>
                      <div class="form-group">
                        <label>Mã khách hàng / SĐT</label>
                        <input type="text" id="customer-id" placeholder="Nhập mã KH hoặc số điện thoại">
                      </div>
                      <div class="form-group">
                        <label>Loại xe</label>
                        <select id="vehicle-type">
                          <option value="">Chọn loại xe</option>
                          <option value="klara-a1">VinFast Klara A1</option>
                          <option value="klara-a2">VinFast Klara A2</option>
                          <option value="ludo">VinFast Ludo</option>
                          <option value="pcx">Honda PCX Electric</option>
                        </select>
                      </div>
                      <button class="btn btn-primary" onclick="lookupCustomer()">🔍 Tra cứu</button>
                    </div>
                    
                    <div class="card">
                      <h4>🔋 Chọn pin</h4>
                      <div class="form-group">
                        <label>Pin cần thay (từ xe)</label>
                        <select id="old-battery">
                          <option value="">Chọn pin cũ</option>
                          <option value="BAT001">BAT001 - 25% (Cần thay)</option>
                          <option value="BAT002">BAT002 - 15% (Cần thay)</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Pin thay thế</label>
                        <select id="new-battery">
                          <option value="">Chọn pin mới</option>
                          <option value="BAT101">BAT101 - 100% (Sẵn sàng)</option>
                          <option value="BAT102">BAT102 - 98% (Sẵn sàng)</option>
                          <option value="BAT103">BAT103 - 100% (Sẵn sàng)</option>
                        </select>
                      </div>
                      <button class="btn btn-success" onclick="startManualSwap()">🚀 Bắt đầu đổi pin</button>
                    </div>
                  </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
                  <div class="data-table">
                    <div class="table-header">
                      <h3>Yêu cầu đổi pin</h3>
                      <div class="table-filters">
                        <select class="filter-select">
                          <option value="all">Tất cả</option>
                          <option value="pending">Chờ xử lý</option>
                          <option value="processing">Đang xử lý</option>
                          <option value="completed">Hoàn thành</option>
                        </select>
                      </div>
                    </div>
                    <div id="swap-requests-container">
                      <div class="swap-request-item priority-high">
                        <div class="request-info">
                          <strong>Nguyễn Văn A</strong> - VinFast Klara A2<br>
                          <span class="muted">16:30 - Pin 12% - Khẩn cấp</span>
                        </div>
                        <div class="request-actions">
                          <button class="btn btn-primary" onclick="processSwapRequest('REQ001', 'high')">Xử lý</button>
                          <button class="btn btn-danger" onclick="rejectSwapRequest('REQ001')">Từ chối</button>
                        </div>
                      </div>
                      
                      <div class="swap-request-item priority-medium">
                        <div class="request-info">
                          <strong>Trần Thị B</strong> - VinFast Ludo<br>
                          <span class="muted">15:45 - Pin 28% - Bình thường</span>
                        </div>
                        <div class="request-actions">
                          <button class="btn btn-primary" onclick="processSwapRequest('REQ002', 'medium')">Xử lý</button>
                          <button class="btn btn-danger" onclick="rejectSwapRequest('REQ002')">Từ chối</button>
                        </div>
                      </div>
                      
                      <div class="swap-request-item priority-low">
                        <div class="request-info">
                          <strong>Lê Văn C</strong> - Honda PCX Electric<br>
                          <span class="muted">14:20 - Pin 45% - Không khẩn cấp</span>
                        </div>
                        <div class="request-actions">
                          <button class="btn btn-primary" onclick="processSwapRequest('REQ003', 'low')">Xử lý</button>
                          <button class="btn btn-danger" onclick="rejectSwapRequest('REQ003')">Từ chối</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="data-table">
                    <div class="table-header">
                      <h3>Quản lý pin</h3>
                      <div class="table-filters">
                        <select class="filter-select">
                          <option value="all">Tất cả</option>
                          <option value="ready">Sẵn sàng</option>
                          <option value="charging">Đang sạc</option>
                          <option value="maintenance">Bảo trì</option>
                        </select>
                      </div>
                    </div>
                    <table>
                      <thead>
                        <tr>
                          <th>ID Pin</th>
                          <th>Loại</th>
                          <th>Tình trạng</th>
                          <th>Pin (%)</th>
                          <th>Thao tác</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>#BAT101</td>
                          <td>72V 20Ah</td>
                          <td><span class="status success">Sẵn sàng</span></td>
                          <td>100%</td>
                          <td><button class="action-btn" onclick="manageBattery('BAT101')">Quản lý</button></td>
                        </tr>
                        <tr>
                          <td>#BAT102</td>
                          <td>72V 32Ah</td>
                          <td><span class="status warning">Đang sạc</span></td>
                          <td>85%</td>
                          <td><button class="action-btn" onclick="manageBattery('BAT102')">Quản lý</button></td>
                        </tr>
                        <tr>
                          <td>#BAT103</td>
                          <td>72V 20Ah</td>
                          <td><span class="status success">Sẵn sàng</span></td>
                          <td>98%</td>
                          <td><button class="action-btn" onclick="manageBattery('BAT103')">Quản lý</button></td>
                        </tr>
                        <tr>
                          <td>#BAT104</td>
                          <td>72V 20Ah</td>
                          <td><span class="status danger">Bảo trì</span></td>
                          <td>0%</td>
                          <td><button class="action-btn" onclick="manageBattery('BAT104')">Quản lý</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      getAdminDashboardHtml() {
        return `
          <div id="adminDashboard" class="dashboard">
            <div class="dashboard-header">
              <div class="container">
                <div class="dashboard-nav">
                  <div class="brand">
                    <div class="logo">
                      <svg viewBox="0 0 24 24"><path d="M6 3h6l-1.5 3H7.8L6 3zm12 18h-6l1.5-3h2.7L18 21zM5 9h9l-1.5 3H6.5L5 9zm14 6h-9l1.5-3h6.5L19 15z"/></svg>
                    </div>
                    Dashboard Quản Trị
                  </div>
                  <div class="user-info">
                    <div class="user-avatar">${this.currentUser.name.charAt(0)}</div>
                    <div>
                      <div>${this.currentUser.name}</div>
                      <div class="muted">Quản trị viên</div>
                    </div>
                    <button class="logout-btn" onclick="auth.logout()">Đăng xuất</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-content">
              <div class="container">
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value">1,247</div>
                    <div class="stat-label">Người dùng</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">24</div>
                    <div class="stat-label">Trạm hoạt động</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">52.8M</div>
                    <div class="stat-label">Doanh thu (VNĐ)</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">98.2%</div>
                    <div class="stat-label">Uptime hệ thống</div>
                  </div>
                </div>

                <!-- PDF Report Scheduler -->
                <div class="report-scheduler">
                  <h3>📧 Lập lịch gửi báo cáo PDF</h3>
                  <p class="muted">Tự động gửi báo cáo định kỳ qua email cho ban quản lý</p>
                  
                  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card">
                      <h4>📅 Tạo lịch mới</h4>
                      <div class="form-group">
                        <label>Loại báo cáo</label>
                        <select id="report-type">
                          <option value="daily">Báo cáo hàng ngày</option>
                          <option value="weekly">Báo cáo hàng tuần</option>
                          <option value="monthly">Báo cáo hàng tháng</option>
                          <option value="custom">Báo cáo tùy chỉnh</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Email nhận</label>
                        <input type="email" id="recipient-email" placeholder="admin@company.com">
                      </div>
                      <div class="form-group">
                        <label>Thời gian gửi</label>
                        <input type="time" id="send-time" value="08:00">
                      </div>
                      <button class="btn btn-primary" onclick="createReportSchedule()">➕ Tạo lịch</button>
                    </div>
                    
                    <div class="card">
                      <h4>📊 Xem trước báo cáo</h4>
                      <div class="email-preview">
Subject: [SWP201] Báo cáo hệ thống hàng ngày - ${new Date().toLocaleDateString('vi-VN')}

Kính gửi Ban Quản lý,

Báo cáo tình hình hoạt động hệ thống SWP201:

📊 THỐNG KÊ TỔNG QUAN:
- Tổng giao dịch: 1,247 lượt
- Doanh thu: 52,800,000 VNĐ  
- Người dùng hoạt động: 856 người
- Tỷ lệ thành công: 98.2%

🔋 TÌNH TRẠNG TRẠM:
- Trạm hoạt động: 24/26 (92.3%)
- Pin sẵn sàng: 342/400 (85.5%)
- Trạm bảo trì: 2 trạm

Chi tiết đầy đủ trong file PDF đính kèm.

Trân trọng,
Hệ thống SWP201
                      </div>
                      <button class="btn btn-success" onclick="sendTestReport()">📧 Gửi thử</button>
                    </div>
                  </div>
                  
                  <h4>📋 Lịch đã tạo</h4>
                  <div id="scheduled-reports">
                    <div class="schedule-item">
                      <div class="schedule-info">
                        <strong>Báo cáo hàng ngày</strong><br>
                        <span class="muted">admin@company.com - 08:00 hàng ngày</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="schedule-status active">Đang hoạt động</span>
                        <button class="btn" onclick="editSchedule('SCH001')">Sửa</button>
                        <button class="btn btn-danger" onclick="deleteSchedule('SCH001')">Xóa</button>
                      </div>
                    </div>
                    
                    <div class="schedule-item">
                      <div class="schedule-info">
                        <strong>Báo cáo hàng tuần</strong><br>
                        <span class="muted">manager@company.com - Thứ 2, 09:00</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="schedule-status active">Đang hoạt động</span>
                        <button class="btn" onclick="editSchedule('SCH002')">Sửa</button>
                        <button class="btn btn-danger" onclick="deleteSchedule('SCH002')">Xóa</button>
                      </div>
                    </div>
                    
                    <div class="schedule-item">
                      <div class="schedule-info">
                        <strong>Báo cáo hàng tháng</strong><br>
                        <span class="muted">ceo@company.com - Ngày 1 hàng tháng, 10:00</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="schedule-status inactive">Tạm dừng</span>
                        <button class="btn" onclick="editSchedule('SCH003')">Sửa</button>
                        <button class="btn btn-danger" onclick="deleteSchedule('SCH003')">Xóa</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px;">
                  <div class="data-table">
                    <div class="table-header">
                      <h3>Quản lý thanh toán</h3>
                      <div class="table-filters">
                        <select class="filter-select">
                          <option value="all">Tất cả</option>
                          <option value="success">Thành công</option>
                          <option value="pending">Chờ xử lý</option>
                          <option value="failed">Thất bại</option>
                        </select>
                        <select class="filter-select">
                          <option value="all">Tất cả phương thức</option>
                          <option value="qr">QR Code</option>
                          <option value="card">Thẻ tín dụng</option>
                          <option value="wallet">Ví điện tử</option>
                        </select>
                        <input type="date" class="filter-input">
                      </div>
                    </div>
                    <table>
                      <thead>
                        <tr>
                          <th>Mã GD</th>
                          <th>Khách hàng</th>
                          <th>Số tiền</th>
                          <th>Phương thức</th>
                          <th>Trạng thái</th>
                          <th>Thao tác</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>#TX001</td>
                          <td>Nguyễn Văn A</td>
                          <td>89,000đ</td>
                          <td>QR Code</td>
                          <td><span class="status success">Thành công</span></td>
                          <td><button class="action-btn">Chi tiết</button></td>
                        </tr>
                        <tr>
                          <td>#TX002</td>
                          <td>Trần Thị B</td>
                          <td>299,000đ</td>
                          <td>Ví điện tử</td>
                          <td><span class="status warning">Chờ xử lý</span></td>
                          <td><button class="action-btn">Xử lý</button></td>
                        </tr>
                        <tr>
                          <td>#TX003</td>
                          <td>Lê Văn C</td>
                          <td>89,000đ</td>
                          <td>Thẻ tín dụng</td>
                          <td><span class="status danger">Thất bại</span></td>
                          <td><button class="action-btn">Hoàn tiền</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div>
                    <div class="card" style="margin-bottom: 20px;">
                      <h3>Thống kê trạm</h3>
                      <div style="margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                          <span>Trạm hoạt động:</span>
                          <span style="color: var(--ok);">24/26</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                          <span>Trạm bảo trì:</span>
                          <span style="color: var(--warn);">2/26</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                          <span>Pin sẵn sàng:</span>
                          <span style="color: var(--ok);">342/400</span>
                        </div>
                      </div>
                      <button class="btn btn-primary" style="width: 100%;">Quản lý trạm</button>
                    </div>

                    <div class="card">
                      <h3>Hành động nhanh</h3>
                      <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                        <button class="btn" onclick="exportInstantReport()">📊 Xuất báo cáo ngay</button>
                        <button class="btn">👥 Quản lý người dùng</button>
                        <button class="btn">⚙️ Cài đặt hệ thống</button>
                        <button class="btn">📋 Xem logs</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      showVehicleSelection() {
        // Hide other content
        document.querySelector('main').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        document.querySelector('footer').style.display = 'none';

        // Remove existing vehicle selection modal if any
        const existing = document.getElementById('vehicleSelectionModal');
        if (existing) existing.remove();

        // Get vehicles from selected plan
        let userVehicles = [];
        if (this.currentUser.selectedPlan && this.currentUser.selectedPlan.vehicles) {
          userVehicles = this.currentUser.selectedPlan.vehicles.map(vehicle => ({
            id: vehicle.id,
            name: vehicle.name,
            icon: vehicle.icon,
            batteryCapacity: vehicle.batteryCapacity,
            description: vehicle.description,
            currentCharge: Math.floor(Math.random() * 30) + 70, // Random charge 70-100%
            health: Math.floor(Math.random() * 10) + 90, // Random health 90-100%
            type: 'scooter',
            batteryId: `BAT_${vehicle.id}`,
            cycleCount: Math.floor(Math.random() * 200) + 50,
            manufactureDate: '2024-01-01',
            lastChecked: new Date().toISOString(),
            planId: this.currentUser.selectedPlan.id,
            planName: this.currentUser.selectedPlan.name
          }));
        } else {
          // Fallback vehicles if no plan selected
          userVehicles = [
            {
              id: 'FALLBACK_001',
              name: 'VinFast Klara A2',
              icon: '🛵',
              batteryCapacity: 2.5,
              currentCharge: 85,
              health: 95
            }
          ];
        }

        // Create vehicle selection modal
        const modal = document.createElement('div');
        modal.id = 'vehicleSelectionModal';
        modal.className = 'vehicle-selection-modal';
        modal.innerHTML = `
          <div class="vehicle-selection-content">
            <div class="vehicle-selection-header">
              <h2>🏍️ Chọn Xe Cho ${this.currentUser.selectedPlan ? this.currentUser.selectedPlan.name : 'Plan'}</h2>
              <p>Chọn xe máy điện từ gói ${this.currentUser.selectedPlan ? this.currentUser.selectedPlan.name : ''} của bạn</p>
              ${this.currentUser.selectedPlan ? `
                <div class="selected-plan-info">
                  <span class="plan-badge" style="background: ${this.currentUser.selectedPlan.color}">
                    ${this.currentUser.selectedPlan.icon} ${this.currentUser.selectedPlan.name}
                  </span>
                </div>
              ` : ''}
            </div>
            <div class="vehicles-grid">
              ${userVehicles.map(vehicle => `
                <div class="vehicle-option" data-vehicle-id="${vehicle.id}">
                  <span class="vehicle-icon">${vehicle.icon}</span>
                  <div class="vehicle-name">${vehicle.name}</div>
                  <div class="vehicle-details">
                    Pin: ${vehicle.batteryCapacity} kWh<br>
                    Mã: ${vehicle.id}
                    ${vehicle.description ? `<br><small style="color: #888;">${vehicle.description}</small>` : ''}
                  </div>
                  <div class="vehicle-battery">
                    ${vehicle.currentCharge}% pin - ${vehicle.health}% health
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="modal-actions">
              <button class="btn btn-primary" onclick="auth.selectVehicleAndContinue()" disabled id="continueBtn">
                Tiếp tục vào Dashboard
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add click handlers for vehicle selection
        modal.querySelectorAll('.vehicle-option').forEach(option => {
          option.addEventListener('click', () => {
            // Remove selected class from all options
            modal.querySelectorAll('.vehicle-option').forEach(opt => opt.classList.remove('selected'));
            // Add selected class to clicked option
            option.classList.add('selected');
            // Enable continue button
            document.getElementById('continueBtn').disabled = false;
            // Store selected vehicle id
            this.selectedVehicleId = option.dataset.vehicleId;
          });
        });
      }

      selectVehicleAndContinue() {
        if (!this.selectedVehicleId) {
          console.error('No vehicle selected');
          showToast('Vui lòng chọn một xe trước khi tiếp tục', 'warning');
          return;
        }

        // Get vehicles from selected plan (same logic as showVehicleSelection)
        let userVehicles = [];
        if (this.currentUser.selectedPlan && this.currentUser.selectedPlan.vehicles) {
          userVehicles = this.currentUser.selectedPlan.vehicles.map(vehicle => ({
            id: vehicle.id,
            name: vehicle.name,
            icon: vehicle.icon,
            batteryCapacity: vehicle.batteryCapacity,
            description: vehicle.description,
            currentCharge: Math.floor(Math.random() * 30) + 70,
            health: Math.floor(Math.random() * 10) + 90,
            type: 'scooter',
            batteryId: `BAT_${vehicle.id}`,
            cycleCount: Math.floor(Math.random() * 200) + 50,
            manufactureDate: '2024-01-01',
            lastChecked: new Date().toISOString(),
            planId: this.currentUser.selectedPlan.id,
            planName: this.currentUser.selectedPlan.name
          }));
        } else {
          console.error('No plan selected or plan has no vehicles');
          showToast('Lỗi: Không có gói dịch vụ hoặc xe nào được chọn', 'error');
          return;
        }

        const selectedVehicle = userVehicles.find(v => v.id === this.selectedVehicleId);
        if (selectedVehicle) {
          // Store selected vehicle in current user
          this.currentUser.selectedVehicle = selectedVehicle;
          localStorage.setItem('currentUser', JSON.stringify(this.currentUser));

          console.log('Vehicle selected successfully:', selectedVehicle.name);
          showToast(`Đã chọn xe ${selectedVehicle.name}`, 'success');

          // Remove modal
          const modal = document.getElementById('vehicleSelectionModal');
          if (modal) modal.remove();

          // Continue to dashboard
          this.showDashboard();
        } else {
          console.error('Selected vehicle not found');
          showToast('Lỗi: Không tìm thấy xe đã chọn', 'error');
        }
      }

      showPlanSelection() {
        // Hide other content
        document.querySelector('main').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        document.querySelector('footer').style.display = 'none';

        // Remove existing plan selection modal if any
        const existing = document.getElementById('planSelectionModal');
        if (existing) existing.remove();

        // Define available plans
        const plans = [
          {
            id: 'basic',
            name: 'Basic Plan',
            icon: '🥉',
            price: '299,000 VNĐ/tháng',
            features: ['2 lần đổi pin/ngày', 'Hỗ trợ 24/7', 'Xe máy điện cơ bản'],
            vehicles: [
              { id: 'BASIC_001', name: 'VinFast Klara A1', icon: '🛴', batteryCapacity: 1.3, description: 'Xe cơ bản, phù hợp di chuyển trong thành phố' }
            ],
            color: '#6c757d'
          },
          {
            id: 'premium',
            name: 'Premium Plan',
            icon: '🥈',
            price: '499,000 VNĐ/tháng',
            features: ['5 lần đổi pin/ngày', 'Ưu tiên hỗ trợ', 'Xe máy điện cao cấp', 'Thống kê pin chi tiết'],
            vehicles: [
              { id: 'PREMIUM_001', name: 'VinFast Klara A2', icon: '🛵', batteryCapacity: 2.5, description: 'Xe cao cấp với pin lớn và tính năng thông minh' },
              { id: 'PREMIUM_002', name: 'VinFast Ludo', icon: '🛴', batteryCapacity: 1.8, description: 'Thiết kế hiện đại, tiết kiệm năng lượng' }
            ],
            color: '#6f42c1'
          },
          {
            id: 'vip',
            name: 'VIP Plan',
            icon: '🥇',
            price: '799,000 VNĐ/tháng',
            features: ['Không giới hạn đổi pin', 'Hỗ trợ VIP 24/7', 'Xe máy điện cao cấp nhất', 'AI tối ưu pin', 'Bảo hành toàn diện'],
            vehicles: [
              { id: 'VIP_001', name: 'Honda PCX Electric', icon: '🏍️', batteryCapacity: 1.3, description: 'Xe điện cao cấp từ Honda với công nghệ tiên tiến' },
              { id: 'VIP_002', name: 'VinFast Klara A2 Pro', icon: '🛵', batteryCapacity: 3.0, description: 'Phiên bản Pro với pin siêu lớn và tính năng AI' },
              { id: 'VIP_003', name: 'Yamaha E-Vino', icon: '🏍️', batteryCapacity: 2.2, description: 'Thiết kế Nhật Bản với hiệu suất vượt trội' }
            ],
            color: '#ffc107'
          }
        ];

        // Create plan selection modal
        const modal = document.createElement('div');
        modal.id = 'planSelectionModal';
        modal.className = 'plan-selection-modal';
        modal.innerHTML = `
          <div class="plan-selection-content">
            <div class="plan-selection-header">
              <h2>📋 Chọn Gói Dịch Vụ</h2>
              <p>Chọn gói dịch vụ phù hợp với nhu cầu của bạn</p>
            </div>
            <div class="plans-grid">
              ${plans.map(plan => `
                <div class="plan-option" data-plan-id="${plan.id}" style="border-color: ${plan.color}">
                  <div class="plan-header" style="background: ${plan.color}">
                    <span class="plan-icon">${plan.icon}</span>
                    <h3>${plan.name}</h3>
                    <div class="plan-price">${plan.price}</div>
                  </div>
                  <div class="plan-features">
                    <h4>Tính năng:</h4>
                    <ul>
                      ${plan.features.map(feature => `<li>✓ ${feature}</li>`).join('')}
                    </ul>
                    <h4>Xe có sẵn:</h4>
                    <div class="plan-vehicles">
                      ${plan.vehicles.map(vehicle => `
                        <div class="vehicle-preview">
                          <span>${vehicle.icon}</span>
                          <div>
                            <strong>${vehicle.name}</strong><br>
                            <small>Pin: ${vehicle.batteryCapacity} kWh</small>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="modal-actions">
              <button class="btn btn-primary" onclick="auth.selectPlanAndContinue()" disabled id="planContinueBtn">
                Tiếp tục chọn xe
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add click handlers for plan selection
        modal.querySelectorAll('.plan-option').forEach(option => {
          option.addEventListener('click', () => {
            // Remove selected class from all options
            modal.querySelectorAll('.plan-option').forEach(opt => opt.classList.remove('selected'));
            // Add selected class to clicked option
            option.classList.add('selected');
            // Enable continue button
            document.getElementById('planContinueBtn').disabled = false;
            // Store selected plan id
            this.selectedPlanId = option.dataset.planId;
            this.selectedPlan = plans.find(p => p.id === this.selectedPlanId);
          });
        });
      }

      selectPlanAndContinue() {
        if (!this.selectedPlan) return;

        // Store selected plan in current user
        this.currentUser.selectedPlan = this.selectedPlan;
        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));

        // Remove plan modal
        const modal = document.getElementById('planSelectionModal');
        if (modal) modal.remove();

        // Show vehicle selection for the selected plan
        this.showVehicleSelection();
      }
    }

    // Global auth instance
    const auth = new AuthSystem();

    // Map functionality
    let map;
    const stations = [
      { name: "Trạm Bùi Thị Xuân", lat: 10.7769, lng: 106.7009, area: "Quận 1, TP.HCM", status: "active", pins: 8 },
      { name: "Trạm Cầu Giấy", lat: 21.0285, lng: 105.8542, area: "Cầu Giấy, Hà Nội", status: "active", pins: 12 },
      { name: "Trạm Hải Châu", lat: 16.0678, lng: 108.2208, area: "Hải Châu, Đà Nẵng", status: "active", pins: 6 },
      { name: "Trạm Thủ Đức", lat: 10.8411, lng: 106.8108, area: "TP. Thủ Đức, TP.HCM", status: "active", pins: 15 },
      { name: "Trạm Long Biên", lat: 21.0467, lng: 105.8917, area: "Long Biên, Hà Nội", status: "maintenance", pins: 0 },
      { name: "Trạm Sơn Trà", lat: 16.1097, lng: 108.2597, area: "Sơn Trà, Đà Nẵng", status: "active", pins: 9 }
    ];

    function initMap() {
      try {
        console.log('Creating map...');
        
        // Check if Leaflet is loaded
        if (typeof L === 'undefined') {
          throw new Error('Leaflet library not loaded');
        }
        
        // Check if map container exists
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
          throw new Error('Map container not found');
        }
        
        console.log('Map container found, creating Leaflet map...');
        map = L.map('map').setView([16.0678, 108.2208], 6);
        console.log('Leaflet map created');
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        console.log('Tile layer added');

        stations.forEach(station => {
          const color = station.status === 'active' ? 'green' : 'red';
          const icon = L.divIcon({
            html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
            iconSize: [20, 20],
            className: 'custom-div-icon'
          });

          const marker = L.marker([station.lat, station.lng], { icon })
            .addTo(map)
            .bindPopup(`
              <strong>${station.name}</strong><br>
              ${station.area}<br>
              Pin sẵn sàng: ${station.pins}<br>
              Trạng thái: ${station.status === 'active' ? 'Hoạt động' : 'Bảo trì'}
            `);
        });
        
        console.log('Map initialization completed successfully');
      } catch (error) {
        console.error('Error in initMap():', error);
        // Show error message in map container
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 400px; background: #1a1a2e; color: white; text-align: center; border-radius: 8px;">
              <div>
                <h3>❌ Lỗi tải bản đồ</h3>
                <p>Không thể tải Leaflet map: ${error.message}</p>
                <button onclick="location.reload()" style="background: #4f8cff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">🔄 Refresh</button>
              </div>
            </div>
          `;
        }
      }
    }

    // Fixed showLogin function
    function showLogin() {
      console.log('showLogin() called');
      
      // Close any existing modals first
      closeModal('registerModal');
      
      const modal = document.getElementById('loginModal');
      if (modal) {
        modal.style.display = 'block';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        console.log('Login modal opened successfully');
      } else {
        console.error('loginModal element not found');
        showToast('Lỗi: Không thể mở modal đăng nhập', 'error');
      }
    }

    function showRegister() {
      console.log('showRegister() called');
      
      // Close any existing modals first
      closeModal('loginModal');
      
      const modal = document.getElementById('registerModal');
      if (modal) {
        modal.style.display = 'block';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
        console.log('Register modal opened successfully');
      } else {
        console.error('registerModal element not found');
        showToast('Lỗi: Không thể mở modal đăng ký', 'error');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      }
    }

    function quickLogin(role, username, password) {
      document.getElementById('username').value = username;
      document.getElementById('password').value = password;
      document.getElementById('userRole').value = role;
      handleLogin(new Event('submit'));
    }

    function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const role = document.getElementById('userRole').value;

      if (auth.login(username, password, role)) {
        showToast('Đăng nhập thành công!', 'success');
        closeModal('loginModal');
      } else {
        showToast('Thông tin đăng nhập không đúng!', 'error');
      }
      return false;
    }

    function handleRegister(event) {
      event.preventDefault();
      showToast('Đăng ký thành công! Vui lòng đăng nhập.', 'success');
      closeModal('registerModal');
      showLogin();
      return false;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    function scrollToId(id) {
      document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function showContact() {
      scrollToId('contact');
    }

    function findNearestStation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          map.setView([lat, lng], 12);
          showToast('Đã tìm trạm gần nhất dựa trên vị trí của bạn', 'success');
        });
      } else {
        showToast('Trình duyệt không hỗ trợ định vị', 'warning');
      }
    }

    // Initialize with error handling
    window.addEventListener('load', () => {
      console.log('Window loaded, starting initialization...');
      try {
        console.log('Attempting to initialize map...');
        initMap();
        console.log('Map initialized successfully');
      } catch (error) {
        console.error('Error initializing map:', error);
        // Continue even if map fails
      }
      
      try {
        console.log('Testing DOM elements...');
        const loginBtn = document.querySelector('button[onclick="showLogin()"]');
        const loginModal = document.getElementById('loginModal');
        console.log('Login button found:', !!loginBtn);
        console.log('Login modal found:', !!loginModal);
        
        if (!loginBtn) {
          console.error('Login button not found!');
        }
        if (!loginModal) {
          console.error('Login modal not found!');
        }
      } catch (error) {
        console.error('Error checking DOM elements:', error);
      }
    });

    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });

    // User Dashboard Functions
    function showUserTab(tabName) {
      // Remove active class from all tabs and contents
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and content
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Initialize map if map tab is selected
      if (tabName === 'map') {
        setTimeout(() => initUserMap(), 100);
      }
      
      // Initialize battery health if battery-health tab is selected
      if (tabName === 'battery-health') {
        setTimeout(() => {
          try {
            console.log('Initializing Battery Health System...');
            if (window.batteryHealthSystem) {
              console.log('Using existing battery health system');
              const content = window.batteryHealthSystem.renderDashboard();
              document.getElementById('batteryHealthContent').innerHTML = content;
            } else {
              console.log('Creating new battery health system');
              // Check if BatteryHealthSystem class exists
              if (typeof BatteryHealthSystem !== 'undefined') {
                window.batteryHealthSystem = new BatteryHealthSystem();
                const content = window.batteryHealthSystem.renderDashboard();
                document.getElementById('batteryHealthContent').innerHTML = content;
                console.log('Battery health system initialized successfully');
              } else {
                console.error('BatteryHealthSystem class not found');
                document.getElementById('batteryHealthContent').innerHTML = `
                  <div style="text-align: center; padding: 40px; color: var(--danger);">
                    <h3>❌ Lỗi tải Battery Health System</h3>
                    <p>Không thể khởi tạo hệ thống quản lý pin. Vui lòng refresh trang.</p>
                    <button class="btn btn-primary" onclick="location.reload()">🔄 Refresh Trang</button>
                  </div>
                `;
              }
            }
          } catch (error) {
            console.error('Error initializing battery health:', error);
            document.getElementById('batteryHealthContent').innerHTML = `
              <div style="text-align: center; padding: 40px; color: var(--danger);">
                <h3>❌ Lỗi: ${error.message}</h3>
                <p>Vui lòng kiểm tra console để xem chi tiết lỗi.</p>
                <button class="btn btn-primary" onclick="location.reload()">🔄 Refresh Trang</button>
              </div>
            `;
          }
        }, 100);
      }
    }

    // Global station data that can be updated
    let globalStationData = {
      station1: [
        { 
          id: 'A1', 
          name: 'Trụ A1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'has-battery', battery: '95%' },
            { id: 3, status: 'empty', battery: '0%' },
            { id: 4, status: 'charging', battery: '75%' },
            { id: 5, status: 'charging', battery: '100%' },
            { id: 6, status: 'has-battery', battery: '98%' },
            { id: 7, status: 'empty', battery: '0%' },
            { id: 8, status: 'charging', battery: '88%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '100%' }
          ]
        },
        { 
          id: 'A2', 
          name: 'Trụ A2',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'empty', battery: '0%' },
            { id: 3, status: 'charging', battery: '92%' },
            { id: 4, status: 'empty', battery: '0%' },
            { id: 5, status: 'charging', battery: '85%' },
            { id: 6, status: 'has-battery', battery: '96%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'empty', battery: '0%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '67%' }
          ]
        },
        { 
          id: 'B1', 
          name: 'Trụ B1',
          slots: [
            { id: 1, status: 'charging', battery: '45%' },
            { id: 2, status: 'charging', battery: '100%' },
            { id: 3, status: 'empty', battery: '0%' },
            { id: 4, status: 'charging', battery: '68%' },
            { id: 5, status: 'has-battery', battery: '100%' },
            { id: 6, status: 'empty', battery: '0%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'has-battery', battery: '94%' },
            { id: 9, status: 'charging', battery: '72%' },
            { id: 10, status: 'empty', battery: '0%' }
          ]
        }
      ],
      station2: [
        { 
          id: 'C1', 
          name: 'Trụ C1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'charging', battery: '88%' },
            { id: 3, status: 'has-battery', battery: '96%' },
            { id: 4, status: 'empty', battery: '0%' },
            { id: 5, status: 'charging', battery: '100%' },
            { id: 6, status: 'has-battery', battery: '100%' },
            { id: 7, status: 'empty', battery: '0%' },
            { id: 8, status: 'charging', battery: '54%' },
            { id: 9, status: 'has-battery', battery: '92%' },
            { id: 10, status: 'charging', battery: '100%' }
          ]
        },
        { 
          id: 'D1', 
          name: 'Trụ D1',
          slots: [
            { id: 1, status: 'charging', battery: '100%' },
            { id: 2, status: 'charging', battery: '65%' },
            { id: 3, status: 'has-battery', battery: '100%' },
            { id: 4, status: 'charging', battery: '94%' },
            { id: 5, status: 'empty', battery: '0%' },
            { id: 6, status: 'has-battery', battery: '98%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'empty', battery: '0%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '79%' }
          ]
        }
      ],
      station3: [
        { 
          id: 'E1', 
          name: 'Trụ E1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'charging', battery: '78%' },
            { id: 3, status: 'charging', battery: '100%' },
            { id: 4, status: 'empty', battery: '0%' },
            { id: 5, status: 'charging', battery: '56%' },
            { id: 6, status: 'has-battery', battery: '95%' },
            { id: 7, status: 'charging', battery: '100%' },
            { id: 8, status: 'empty', battery: '0%' },
            { id: 9, status: 'has-battery', battery: '100%' },
            { id: 10, status: 'charging', battery: '83%' }
          ]
        }
      ],
      station4: [
        { 
          id: 'F1', 
          name: 'Trụ F1',
          slots: [
            { id: 1, status: 'has-battery', battery: '100%' },
            { id: 2, status: 'charging', battery: '100%' },
            { id: 3, status: 'empty', battery: '0%' },
            { id: 4, status: 'has-battery', battery: '97%' },
            { id: 5, status: 'charging', battery: '62%' },
            { id: 6, status: 'empty', battery: '0%' },
            { id: 7, status: 'has-battery', battery: '100%' },
            { id: 8, status: 'charging', battery: '100%' },
            { id: 9, status: 'empty', battery: '0%' },
            { id: 10, status: 'charging', battery: '91%' }
          ]
        }
      ]
    };

    function loadStationPosts() {
      const stationSelect = document.getElementById('station-select');
      const postsContainer = document.getElementById('posts-container');
      const postGrid = document.getElementById('post-grid');
      const noStation = document.getElementById('no-station');
      const selectedStation = stationSelect.value;
      
      if (selectedStation) {
        postGrid.style.display = 'block';
        noStation.style.display = 'none';
        
        // Use global data that can be updated
        const posts = globalStationData[selectedStation] || [];
        postsContainer.innerHTML = '';
        
        posts.forEach(post => {
          const readyBatteries = post.slots.filter(slot => 
            slot.status === 'has-battery' || 
            (slot.status === 'charging' && slot.battery === '100%')
          ).length;
          const emptySlots = post.slots.filter(slot => slot.status === 'empty').length;
          const isAvailable = readyBatteries > 0 && emptySlots > 0;
          
          const postElement = document.createElement('div');
          postElement.className = `post-item ${isAvailable ? '' : 'occupied'}`;
          postElement.onclick = () => isAvailable ? selectPost(post) : null;
          
          postElement.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 4px;">${post.name}</div>
            <div style="font-size: 12px; margin-bottom: 4px;">
              🔋 ${readyBatteries} pin sẵn sàng
            </div>
            <div style="font-size: 11px; color: var(--muted);">
                ${emptySlots} slot trống
            </div>
          `;
          
          if (!isAvailable) {
            postElement.style.cursor = 'not-allowed';
            postElement.onclick = null;
          }
          
          postsContainer.appendChild(postElement);
        });
      } else {
        postGrid.style.display = 'none';
        noStation.style.display = 'block';
        hideSelectedPostInfo();
      }
      
      updateSwapButton();
    }

    let selectedPost = null;
    let selectedPickupSlot = null;
    let selectedReturnSlot = null;
    
    function selectPost(post) {
      // Remove previous selection
      document.querySelectorAll('.post-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection to clicked post
      event.target.classList.add('selected');
      
      // Get updated post data from global data
      const stationSelect = document.getElementById('station-select');
      const selectedStationKey = stationSelect.value;
      
      if (globalStationData[selectedStationKey]) {
        const posts = globalStationData[selectedStationKey];
        const updatedPost = posts.find(p => p.id === post.id);
        selectedPost = updatedPost || post;
      } else {
        selectedPost = post;
      }
      
      selectedPickupSlot = null;
      selectedReturnSlot = null;
      
      showSelectedPostInfo(selectedPost);
      updateSwapButton();
    }
    
    function showSelectedPostInfo(post) {
      const selectedPostInfo = document.getElementById('selected-post-info');
      const postDetails = document.getElementById('post-details');
      
      postDetails.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${post.name}</strong><br>
            <span class="muted">  Đã chọn trụ này</span>
          </div>
          <div style="font-size: 24px;">⚡</div>
        </div>
      `;
      
      showSlotSelection(post);
      selectedPostInfo.style.display = 'block';
    }
    
    function showSlotSelection(post) {
      const availableSlots = document.getElementById('available-slots');
      const emptySlots = document.getElementById('empty-slots');
      
      // Clear previous selections
      availableSlots.innerHTML = '';
      emptySlots.innerHTML = '';
      
      post.slots.forEach(slot => {
        if (slot.status === 'has-battery') {
          const slotElement = document.createElement('div');
          // Only show green if battery is 100%, otherwise show as charging
          if (slot.battery === '100%') {
            slotElement.className = 'slot-item has-battery';
            slotElement.onclick = () => selectPickupSlot(slot);
          } else {
            slotElement.className = 'slot-item charging';
            slotElement.style.cursor = 'not-allowed';
            slotElement.style.opacity = '0.8';
          }
          slotElement.innerHTML = `
            <div>Slot ${slot.id}</div>
            <div style="font-size: 10px;">${slot.battery}</div>
            ${slot.battery !== '100%' ? '<div style="font-size: 9px; color: var(--warn);">Chưa đủ</div>' : ''}
          `;
          availableSlots.appendChild(slotElement);
        } else if (slot.status === 'charging') {
          const slotElement = document.createElement('div');
          if (slot.battery === '100%') {
            // Charging complete - can be picked up, show as green like has-battery
            slotElement.className = 'slot-item has-battery';
            slotElement.onclick = () => selectPickupSlot(slot);
            slotElement.innerHTML = `
              <div>Slot ${slot.id}</div>
              <div style="font-size: 10px;">${slot.battery}</div>
              <div style="font-size: 9px; color: var(--ok);">Sẵn sàng</div>
            `;
          } else {
            // Still charging - cannot be picked up
            slotElement.className = 'slot-item charging';
            slotElement.style.cursor = 'not-allowed';
            slotElement.style.opacity = '0.6';
            slotElement.innerHTML = `
              <div>Slot ${slot.id}</div>
              <div style="font-size: 10px;">⚡${slot.battery}</div>
              <div style="font-size: 9px; color: var(--warn);">Đang sạc</div>
            `;
          }
          availableSlots.appendChild(slotElement);
        } else if (slot.status === 'empty') {
          const slotElement = document.createElement('div');
          slotElement.className = 'slot-item empty';
          slotElement.onclick = () => selectReturnSlot(slot);
          slotElement.innerHTML = `
            <div>Slot ${slot.id}</div>
            <div style="font-size: 10px;">Trống</div>
          `;
          emptySlots.appendChild(slotElement);
        }
      });
    }
    
    function selectPickupSlot(slot) {
      // Only allow selection if battery is 100%
      if (slot.battery !== '100%') {
        showToast(`Slot ${slot.id} có pin ${slot.battery}, chỉ có thể lấy pin 100%`, 'warning');
        return;
      }
      
      // Remove previous selections
      document.querySelectorAll('#available-slots .slot-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection
      event.target.classList.add('selected');
      selectedPickupSlot = slot;
      updateSwapButton();
    }
    
    function selectReturnSlot(slot) {
      // Remove previous selections
      document.querySelectorAll('#empty-slots .slot-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection
      event.target.classList.add('selected');
      selectedReturnSlot = slot;
      updateSwapButton();
    }
    
    function hideSelectedPostInfo() {
      document.getElementById('selected-post-info').style.display = 'none';
      selectedPost = null;
      selectedPickupSlot = null;
      selectedReturnSlot = null;
    }
    
    function updateSwapButton() {
      const swapBtn = document.getElementById('swap-btn');
      const stationSelect = document.getElementById('station-select');
      
      const canSwap = stationSelect.value && selectedPost && selectedPickupSlot && selectedReturnSlot;
      
      swapBtn.disabled = !canSwap;
      
      if (canSwap) {
        swapBtn.textContent = `🚀 Lấy pin từ Slot ${selectedPickupSlot.id} → Trả vào Slot ${selectedReturnSlot.id}`;
        swapBtn.style.opacity = '1';
      } else if (selectedPost && (!selectedPickupSlot || !selectedReturnSlot)) {
        swapBtn.textContent = '🔋 Chọn slot lấy pin và slot trả pin';
        swapBtn.style.opacity = '0.6';
      } else {
        swapBtn.textContent = '🚀 Chọn trạm và trụ để tiếp tục';
        swapBtn.style.opacity = '0.6';
      }
    }
    
    function startBatterySwap() {
      if (!selectedPost || !selectedPickupSlot || !selectedReturnSlot) {
        showToast('Vui lòng chọn trụ và slot đổi pin', 'warning');
        return;
      }
      
      const stationName = document.getElementById('station-select').selectedOptions[0].text;
      
      // Show progress
      document.getElementById('swap-status').style.display = 'none';
      document.getElementById('swap-progress').style.display = 'block';
      
      // Simulate IoT process
      simulateSwapProcess(stationName);
    }
    
    function simulateSwapProcess(stationName) {
      const progressText = document.getElementById('progress-text');
      const steps = [
        { text: `Đang mở Slot ${selectedPickupSlot.id}...`, duration: 1500 },
        { text: 'Vui lòng lấy pin mới ra khỏi slot', duration: 2000 },
        { text: `Đang mở Slot ${selectedReturnSlot.id}...`, duration: 1500 },
        { text: 'Vui lòng đặt pin cũ vào slot trống', duration: 2000 },
        { text: 'Đang khóa tất cả slot...', duration: 1000 },
        { text: 'Hoàn thành đổi pin!', duration: 1000 }
      ];
      
      let currentStep = 0;
      
      function nextStep() {
        if (currentStep < steps.length) {
          const step = steps[currentStep];
          progressText.innerHTML = `
            <h4>${step.text}</h4>
            <p class="muted">Bước ${currentStep + 1}/${steps.length}</p>
          `;
          
          setTimeout(() => {
            currentStep++;
            if (currentStep < steps.length) {
              nextStep();
            } else {
              completeSwap(stationName);
            }
          }, step.duration);
        }
      }
      
      nextStep();
    }
    
    function completeSwap(stationName) {
      // Hide progress
      document.getElementById('swap-progress').style.display = 'none';
      
      // Show success
      document.getElementById('swap-status').innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px; color: var(--ok);">✅</div>
        <h4 style="color: var(--ok);">Đổi pin thành công!</h4>
        <p class="muted">Lấy pin từ ${selectedPost.name} - Slot ${selectedPickupSlot.id}</p>
        <p class="muted">Trả pin vào ${selectedPost.name} - Slot ${selectedReturnSlot.id}</p>
        <p class="muted">Pin cũ sẽ được sạc tự động</p>
        <button class="btn btn-primary" onclick="finishSwap()" style="margin-top: 12px;">Hoàn tất đổi pin</button>
      `;
      document.getElementById('swap-status').style.display = 'block';
      
      showToast('🎉 Đổi pin thành công! Pin cũ đang được sạc tự động.', 'success');
    }
    
    function finishSwap() {
      // Update slot states after swap
      updateSlotStates();
      
      // Add new swap record to history
      addSwapHistory();
      
      // Reset form
      document.getElementById('station-select').value = '';
      hideSelectedPostInfo();
      document.getElementById('post-grid').style.display = 'none';
      document.getElementById('no-station').style.display = 'block';
      selectedPost = null;
      selectedPickupSlot = null;
      selectedReturnSlot = null;
      
      // Reset status
      document.getElementById('swap-status').innerHTML = `
        <div style="font-size: 48px; margin-bottom: 16px;">⚡</div>
        <h4>Sẵn sàng đổi pin</h4>
        <p class="muted">Chọn trạm và trụ để bắt đầu</p>
      `;
      
      updateSwapButton();
      showToast('Cảm ơn bạn đã sử dụng dịch vụ!', 'success');
    }

    function updateSlotStates() {
      if (!selectedPost || !selectedPickupSlot || !selectedReturnSlot) return;
      
      // Find the station and post in our global data
      const stationSelect = document.getElementById('station-select');
      const selectedStationKey = stationSelect.value;
      
      // Find current post and update slot states
      if (globalStationData[selectedStationKey]) {
        const posts = globalStationData[selectedStationKey];
        const currentPost = posts.find(post => post.id === selectedPost.id);
        
        if (currentPost) {
          // Update pickup slot to empty
          const pickupSlot = currentPost.slots.find(slot => slot.id === selectedPickupSlot.id);
          if (pickupSlot) {
            pickupSlot.status = 'empty';
            pickupSlot.battery = '0%';
          }
          
          // Update return slot to charging with old battery level
          const returnSlot = currentPost.slots.find(slot => slot.id === selectedReturnSlot.id);
          if (returnSlot) {
            returnSlot.status = 'charging';
            returnSlot.battery = '25%'; // Assume old battery is low
          }
          
          showToast(`Cập nhật: Slot ${selectedPickupSlot.id} → trống, Slot ${selectedReturnSlot.id} → đang sạc 25%`, 'success');
        }
      }
    }

    function addSwapHistory() {
      const now = new Date();
      const timeString = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      
      const stationName = document.getElementById('station-select').selectedOptions[0].text.split('(')[0].trim();
      const stationShort = stationName.replace('Trạm ', '').substring(0, 8);
      
      // Add to battery swap history table
      const historyTable = document.querySelector('#battery-swap-tab table tbody');
      if (historyTable) {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${timeString}</td>
          <td>${stationShort}/${selectedPost.name.replace('Trụ ', '')}</td>
          <td>0đ (Premium)</td>
          <td><span class="status success">Thành công</span></td>
        `;
        historyTable.insertBefore(newRow, historyTable.firstChild);
        
        // Remove last row if more than 5 records
        if (historyTable.children.length > 5) {
          historyTable.removeChild(historyTable.lastChild);
        }
      }
      
      // Add to payment history if in that tab
      const paymentHistoryTable = document.getElementById('payment-history-table');
      if (paymentHistoryTable) {
        const paymentId = '#PAY' + String(Date.now()).slice(-3);
        const newPaymentRow = document.createElement('tr');
        newPaymentRow.innerHTML = `
          <td>${paymentId}</td>
          <td>${timeString}</td>
          <td>Đổi pin</td>
          <td>0đ</td>
          <td>Gói Premium</td>
          <td><span class="status success">Thành công</span></td>
          <td><button class="action-btn" onclick="viewPaymentDetail('${paymentId}')">Chi tiết</button></td>
        `;
        paymentHistoryTable.insertBefore(newPaymentRow, paymentHistoryTable.firstChild);
        
        // Remove last row if more than 8 records
        if (paymentHistoryTable.children.length > 8) {
          paymentHistoryTable.removeChild(paymentHistoryTable.lastChild);
        }
      }
      
      // Add to overview recent activity
      const overviewTable = document.querySelector('#overview-tab table tbody');
      if (overviewTable) {
        const newActivityRow = document.createElement('tr');
        newActivityRow.innerHTML = `
          <td>${timeString}</td>
          <td>Đổi pin tại ${stationShort}</td>
          <td><span class="status success">Hoàn thành</span></td>
        `;
        overviewTable.insertBefore(newActivityRow, overviewTable.firstChild);
        
        // Remove last row if more than 3 records
        if (overviewTable.children.length > 3) {
          overviewTable.removeChild(overviewTable.lastChild);
        }
      }
      
      // Update stats - decrease remaining swaps for premium plan
      updatePremiumPlanStats();
    }
    
    function updatePremiumPlanStats() {
      // Update plan status in battery swap tab
      const planStatus = document.getElementById('plan-status');
      if (planStatus) {
        const currentRemaining = 4; // This would come from user data in real app
        const newRemaining = Math.max(0, currentRemaining - 1);
        planStatus.innerHTML = `
          <div style="background: rgba(25,195,125,0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(25,195,125,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span>📦 Gói Premium:</span><br>
                <span class="muted">Còn lại ${newRemaining}/8 lượt tháng này</span>
              </div>
              <span style="font-size: 20px; font-weight: 700; color: var(--ok);">MIỄN PHÍ</span>
            </div>
          </div>
        `;
      }
      
      // Update overview stats
      const swapCountStat = document.querySelector('#overview-tab .stat-card .stat-value');
      if (swapCountStat && swapCountStat.textContent === '12') {
        swapCountStat.textContent = '13';
      }
    }

    function filterPaymentHistory() {
      // Demo filter function - in real app would filter the table
      showToast('Đã áp dụng bộ lọc', 'success');
    }

    function viewPaymentDetail(paymentId) {
      showToast(`Xem chi tiết giao dịch ${paymentId}`, 'success');
    }

    function selectPlan(planType) {
      if (planType === 'basic') {
        showToast('Bạn đã chuyển sang thanh toán theo lượt', 'success');
      }
    }

    function extendPlan(planType) {
      showToast('Đã gia hạn gói Premium thêm 1 tháng', 'success');
    }

    function upgradePlan(planType) {
      showToast('Yêu cầu nâng cấp lên Enterprise đã được gửi', 'success');
    }

    function updateTopUpAmount() {
      const select = document.getElementById('top-up-amount');
      const customInput = document.getElementById('custom-amount');
      
      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }
    }

    function processTopUp() {
      const amount = document.getElementById('top-up-amount').value;
      const customAmount = document.getElementById('custom-amount').value;
      const finalAmount = amount === 'custom' ? customAmount : amount;
      
      if (finalAmount) {
        showToast(`Đang xử lý nạp ${parseInt(finalAmount).toLocaleString()}đ...`, 'success');
        // In real app, would redirect to payment gateway
      } else {
        showToast('Vui lòng chọn số tiền cần nạp', 'warning');
      }
    }

    let userMap;
    function initUserMap() {
      if (userMap) return; // Don't reinitialize if already exists
      
      userMap = L.map('user-map').setView([16.0678, 108.2208], 6);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(userMap);

      stations.forEach((station, index) => {
        const color = station.status === 'active' ? '#19c37d' : '#ff5573';
        const icon = L.divIcon({
          html: `<div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${station.pins}</div>`,
          iconSize: [24, 24],
          className: 'custom-div-icon'
        });

        const marker = L.marker([station.lat, station.lng], { icon })
          .addTo(userMap)
          .bindPopup(`
            <div style="min-width: 200px;">
              <strong>${station.name}</strong><br>
              📍 ${station.area}<br>
              🔋 ${station.pins} pin sẵn sàng<br>
              📊 Trạng thái: ${station.status === 'active' ? 'Hoạt động' : 'Bảo trì'}<br>
              <button onclick="selectStationForBooking('${station.name}')" style="margin-top: 8px; padding: 4px 8px; background: #4f8cff; border: none; border-radius: 4px; color: white; cursor: pointer;">Đổi pin tại đây</button>
            </div>
          `);

        marker.on('click', () => {
          updateSelectedStationInfo(station);
        });
      });
    }

    function updateSelectedStationInfo(station) {
      const infoDiv = document.getElementById('selected-station-info');
      infoDiv.innerHTML = `
        <h4>${station.name}</h4>
        <p><strong>📍 Địa chỉ:</strong> ${station.area}</p>
        <p><strong>🔋 Pin sẵn sàng:</strong> ${station.pins}</p>
        <p><strong>📊 Trạng thái:</strong> <span class="status ${station.status === 'active' ? 'success' : 'danger'}">${station.status === 'active' ? 'Hoạt động' : 'Bảo trì'}</span></p>
        <div style="margin-top: 12px;">
          <button class="btn btn-primary" onclick="selectStationForBooking('${station.name}')" style="width: 100%;">Đổi pin tại đây</button>
        </div>
      `;
    }

    function selectStationForBooking(stationName) {
      // Switch to battery-swap tab and pre-select station
      showUserTab('battery-swap');
      
      // Find and select the station in dropdown
      const stationSelect = document.getElementById('station-select');
      for (let option of stationSelect.options) {
        if (option.text.includes(stationName)) {
          stationSelect.value = option.value;
          loadStationPosts();
          break;
        }
      }
      
      showToast(`Đã chọn ${stationName} để đổi pin`, 'success');
    }

    function findMyLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          if (userMap) {
            userMap.setView([lat, lng], 12);
            
            // Add user location marker
            L.marker([lat, lng], {
              icon: L.divIcon({
                html: '<div style="background: #4f8cff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                iconSize: [16, 16],
                className: 'user-location-marker'
              })
            }).addTo(userMap).bindPopup('Vị trí của bạn');
          }
          
          showToast('Đã định vị thành công', 'success');
        }, (error) => {
          showToast('Không thể xác định vị trí', 'warning');
        });
      } else {
        showToast('Trình duyệt không hỗ trợ định vị', 'warning');
      }
    }

    function filterActiveStations() {
      showToast('Hiển thị chỉ các trạm đang hoạt động', 'success');
      // In real app, would filter map markers
    }

    function showAllStations() {
      showToast('Hiển thị tất cả các trạm', 'success');
      // In real app, would show all markers
    }

    function searchStations() {
      const searchTerm = document.getElementById('station-search').value.toLowerCase();
      showToast(`Tìm kiếm: "${searchTerm}"`, 'success');
      // In real app, would filter stations list and map
    }

    function filterByDistance() {
      showToast('Đã áp dụng bộ lọc khoảng cách', 'success');
      // In real app, would filter by distance from user location
    }

    function focusStation(stationId) {
      const station = stations.find(s => s.name.includes('Bùi Thị Xuân') && stationId === 'station1') ||
                    stations.find(s => s.name.includes('Cầu Giấy') && stationId === 'station2');
      
      if (station && userMap) {
        userMap.setView([station.lat, station.lng], 15);
        updateSelectedStationInfo(station);
        showToast(`Đã focus vào ${station.name}`, 'success');
      }
    }

    // Payment functions
    let currentPlanOrder = null;

    function purchasePlan(planType, planName, price, description) {
      currentPlanOrder = {
        type: planType,
        name: planName,
        price: price,
        description: description,
        orderDate: new Date().toISOString(),
        orderId: 'SWP' + Date.now()
      };

      document.getElementById('selected-plan-info').textContent = `${planName} - ${price.toLocaleString()}đ`;
      document.getElementById('plan-description').textContent = description;
      document.getElementById('payment-modal').style.display = 'block';
    }

    function closePaymentModal() {
      const modal = document.getElementById('payment-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      }
      
      const step1 = document.getElementById('payment-step-1');
      const step2 = document.getElementById('payment-step-2');
      const step3 = document.getElementById('payment-step-3');
      const paymentBtn = document.getElementById('payment-btn');
      
      if (step1) step1.style.display = 'block';
      if (step2) step2.style.display = 'none';
      if (step3) step3.style.display = 'none';
      if (paymentBtn) paymentBtn.style.display = 'block';
      
      // Reset form
      const cardNumber = document.getElementById('card-number');
      const cardExpiry = document.getElementById('card-expiry');
      const cardCvv = document.getElementById('card-cvv');
      const cardHolder = document.getElementById('card-holder');
      const agreeTerms = document.getElementById('agree-terms');
      
      if (cardNumber) cardNumber.value = '';
      if (cardExpiry) cardExpiry.value = '';
      if (cardCvv) cardCvv.value = '';
      if (cardHolder) cardHolder.value = '';
      if (agreeTerms) agreeTerms.checked = false;
    }

    function processPayment() {
      // Validate form
      const cardNumber = document.getElementById('card-number').value;
      const cardExpiry = document.getElementById('card-expiry').value;
      const cardCvv = document.getElementById('card-cvv').value;
      const cardHolder = document.getElementById('card-holder').value;
      const agreeTerms = document.getElementById('agree-terms').checked;

      if (!cardNumber || !cardExpiry || !cardCvv || !cardHolder || !agreeTerms) {
        showToast('Vui lòng điền đầy đủ thông tin và đồng ý điều khoản', 'error');
        return;
      }

      // Show processing step
      document.getElementById('payment-step-1').style.display = 'none';
      document.getElementById('payment-step-2').style.display = 'block';
      document.getElementById('payment-btn').style.display = 'none';

      // Simulate payment processing
      setTimeout(() => {
        // Payment successful
        document.getElementById('payment-step-2').style.display = 'none';
        document.getElementById('payment-step-3').style.display = 'block';

        // Update user plan
        if (auth.currentUser) {
          auth.currentUser.plan = currentPlanOrder.type;
          auth.currentUser.planExpiry = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();
          localStorage.setItem('userData', JSON.stringify(auth.currentUser));
        }

        // Add to payment history
        addPaymentRecord({
          date: new Date().toLocaleDateString('vi-VN'),
          description: `Mua ${currentPlanOrder.name}`,
          amount: `${currentPlanOrder.price.toLocaleString()}đ`,
          status: 'Thành công',
          orderId: currentPlanOrder.orderId
        });

        showToast('Thanh toán thành công! Gói dịch vụ đã được kích hoạt', 'success');
        
        // Update dashboard
        setTimeout(() => {
          if (document.getElementById('userDashboard').classList.contains('active')) {
            location.reload(); // Refresh to update plan info
          }
        }, 2000);
      }, 3000);
    }

    function showContract() {
      if (!currentPlanOrder) {
        showToast('Không có thông tin đơn hàng', 'error');
        return;
      }

      const user = auth.currentUser;
      const contractDate = new Date().toLocaleDateString('vi-VN');
      const contractId = 'HD' + Date.now();
      
      const contractHTML = `
        <div class="contract-document">
          <div class="contract-header">
            <h2 style="text-align: center; margin-bottom: 10px;">HỢP ĐỒNG DỊCH VỤ ĐỔI PIN ĐIỆN TỬ</h2>
            <div style="text-align: center; font-size: 14px; color: #666; margin-bottom: 30px;">
              Số hợp đồng: ${contractId} | Ngày: ${contractDate}
            </div>
          </div>

          <div class="contract-body">
            <div class="contract-section">
              <h3>BÊN CUNG CẤP DỊCH VỤ (Bên A)</h3>
              <p><strong>Công ty TNHH SWP201 Battery Swap</strong></p>
              <p>Địa chỉ: Lô E2a-7, Đường D1, Đ. D1, Long Thạnh Mỹ, Thành Phố Thủ Đức, Hồ Chí Minh</p>
              <p>Điện thoại: 1900-SWP201 | Email: support@swp201.vn</p>
              <p>Mã số thuế: 0123456789</p>
            </div>

            <div class="contract-section">
              <h3>BÊN SỬ DỤNG DỊCH VỤ (Bên B)</h3>
              <p><strong>${user.name}</strong></p>
              <p>Email: ${user.username}</p>
              <p>Số điện thoại: ${user.phone || 'Chưa cập nhật'}</p>
              <p>Địa chỉ: ${user.address || 'Chưa cập nhật'}</p>
            </div>

            <div class="contract-section">
              <h3>THÔNG TIN GÓI DỊCH VỤ</h3>
              <table class="contract-table">
                <tr>
                  <td><strong>Tên gói:</strong></td>
                  <td>${currentPlanOrder.name}</td>
                </tr>
                <tr>
                  <td><strong>Giá trị:</strong></td>
                  <td>${currentPlanOrder.price.toLocaleString()}đ</td>
                </tr>
                <tr>
                  <td><strong>Thời hạn:</strong></td>
                  <td>30 ngày kể từ ngày kích hoạt</td>
                </tr>
                <tr>
                  <td><strong>Ngày đăng ký:</strong></td>
                  <td>${contractDate}</td>
                </tr>
                <tr>
                  <td><strong>Mã đơn hàng:</strong></td>
                  <td>${currentPlanOrder.orderId}</td>
                </tr>
              </table>
            </div>

            <div class="contract-section">
              <h3>ĐIỀU KHOẢN DỊCH VỤ</h3>
              <ol>
                <li><strong>Quyền và nghĩa vụ của Bên A:</strong>
                  <ul>
                    <li>Cung cấp dịch vụ đổi pin theo đúng gói đã đăng ký</li>
                    <li>Đảm bảo chất lượng pin và an toàn trong quá trình sử dụng</li>
                    <li>Hỗ trợ kỹ thuật 24/7 cho gói Premium và Enterprise</li>
                    <li>Thông báo trước 7 ngày khi có thay đổi chính sách</li>
                  </ul>
                </li>
                <li><strong>Quyền và nghĩa vụ của Bên B:</strong>
                  <ul>
                    <li>Thanh toán đúng hạn theo gói đã đăng ký</li>
                    <li>Sử dụng dịch vụ đúng mục đích và tuân thủ quy định</li>
                    <li>Bảo quản thiết bị và pin trong quá trình sử dụng</li>
                    <li>Thông báo kịp thời khi có sự cố hoặc hỏng hóc</li>
                  </ul>
                </li>
                <li><strong>Chính sách hoàn tiền:</strong>
                  <ul>
                    <li>Hoàn 100% trong 7 ngày đầu nếu chưa sử dụng</li>
                    <li>Hoàn 50% nếu hủy trong 15 ngày đầu</li>
                    <li>Không hoàn tiền sau 15 ngày sử dụng</li>
                  </ul>
                </li>
              </ol>
            </div>

            <div class="contract-section">
              <h3>CHỮ KÝ ĐIỆN TỬ</h3>
              <div class="signature-section">
                <div class="signature-block">
                  <p><strong>Bên A: SWP201 Company</strong></p>
                  <div class="digital-signature">
                    <div class="signature-stamp">
                      ĐÃ KÝ ĐIỆN TỬ<br>
                      <small>CEO Trần Văn An</small><br>
                      <small>${contractDate}</small>
                    </div>
                  </div>
                </div>
                <div class="signature-block">
                  <p><strong>Bên B: ${user.name}</strong></p>
                  <div class="digital-signature">
                    <div class="signature-stamp">
                      ĐÃ KÝ ĐIỆN TỬ<br>
                      <small>${user.username}</small><br>
                      <small>${contractDate}</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="contract-footer">
              <p style="text-align: center; font-style: italic; color: #666;">
                Hợp đồng này được tạo tự động và có giá trị pháp lý theo Luật Giao dịch điện tử Việt Nam
              </p>
            </div>
          </div>
        </div>
      `;

      document.getElementById('contract-content').innerHTML = contractHTML;
      document.getElementById('contract-modal').style.display = 'block';
    }

    function closeContractModal() {
      const modal = document.getElementById('contract-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      }
    }

    function downloadContract() {
      showToast('Tính năng tải xuống PDF sẽ được cập nhật sau', 'info');
    }

    // Format card number input
    document.addEventListener('DOMContentLoaded', function() {
      const cardNumberInput = document.getElementById('card-number');
      if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
          let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
          e.target.value = formattedValue;
        });
      }

      const cardExpiryInput = document.getElementById('card-expiry');
      if (cardExpiryInput) {
        cardExpiryInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value;
        });
      }

      // Battery Health Management System
      class BatteryHealthSystem {
        constructor() {
          this.userBatteries = this.loadUserBatteries();
          this.healthHistory = this.loadHealthHistory();
          this.currentVehicle = null;
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.generateSampleData();
        }

        generateSampleData() {
          if (Object.keys(this.userBatteries).length === 0) {
            const sampleVehicles = [
              {
                id: 'BIKE001',
                name: 'VinFast Klara A2',
                type: 'scooter',
                batteryId: 'BAT001',
                batteryCapacity: 2.5, // kWh
                currentCharge: 85,
                health: 94,
                cycleCount: 156,
                manufactureDate: '2024-02-15',
                lastChecked: new Date().toISOString(),
                icon: '🛵'
              },
              {
                id: 'BIKE002', 
                name: 'VinFast Ludo',
                type: 'scooter',
                batteryId: 'BAT002',
                batteryCapacity: 1.8, // kWh
                currentCharge: 62,
                health: 89,
                cycleCount: 203,
                manufactureDate: '2023-11-08',
                lastChecked: new Date().toISOString(),
                icon: '🛴'
              },
              {
                id: 'BIKE003',
                name: 'Honda PCX Electric',
                type: 'scooter',
                batteryId: 'BAT003',
                batteryCapacity: 1.3, // kWh
                currentCharge: 78,
                health: 91,
                cycleCount: 124,
                manufactureDate: '2024-05-20',
                lastChecked: new Date().toISOString(),
                icon: '🏍️'
              }
            ];

            sampleVehicles.forEach(vehicle => {
              this.userBatteries[vehicle.id] = vehicle;
              this.generateHealthHistory(vehicle.id);
            });

            this.saveUserBatteries();
            this.saveHealthHistory();
          }
        }

        generateHealthHistory(vehicleId) {
          const vehicle = this.userBatteries[vehicleId];
          if (!vehicle) return;

          const history = [];
          const startDate = new Date(vehicle.manufactureDate);
          const currentDate = new Date();
          const daysBetween = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));

          for (let i = 0; i <= daysBetween; i += 7) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            
            const ageMonths = i / 30;
            const baseHealth = 100;
            const degradationRate = 0.5;
            const randomVariation = (Math.random() - 0.5) * 2;
            
            const health = Math.max(
              baseHealth - (ageMonths * degradationRate) + randomVariation,
              vehicle.health - 5
            );

            history.push({
              date: date.toISOString().split('T')[0],
              health: Math.round(health * 10) / 10,
              chargeLevel: Math.floor(Math.random() * 100),
              temperature: Math.floor(Math.random() * 20) + 20,
              cycleCount: Math.floor((i / 7) * 2)
            });
          }

          this.healthHistory[vehicleId] = history;
        }

        loadUserBatteries() {
          const saved = localStorage.getItem('userBatteries');
          return saved ? JSON.parse(saved) : {};
        }

        loadHealthHistory() {
          const saved = localStorage.getItem('batteryHealthHistory');
          return saved ? JSON.parse(saved) : {};
        }

        saveUserBatteries() {
          localStorage.setItem('userBatteries', JSON.stringify(this.userBatteries));
        }

        saveHealthHistory() {
          localStorage.setItem('batteryHealthHistory', JSON.stringify(this.healthHistory));
        }

        setupEventListeners() {
          document.addEventListener('click', (e) => {
            if (e.target.matches('.select-vehicle-btn')) {
              const vehicleId = e.target.dataset.vehicleId;
              this.selectVehicle(vehicleId);
            }
            
            if (e.target.matches('.refresh-data-btn')) {
              this.refreshBatteryData();
            }

            if (e.target.matches('.export-report-btn')) {
              this.exportHealthReport();
            }
          });
        }

        renderBatteryHealthDashboard() {
          // Auto-select vehicle from current user
          const currentUser = auth?.currentUser;
          if (currentUser?.selectedVehicle && !this.currentVehicle) {
            const vehicleId = currentUser.selectedVehicle.id;
            this.currentVehicle = this.userBatteries[vehicleId] || currentUser.selectedVehicle;
          }

          return `
            <div class="battery-health-dashboard">
              <div class="dashboard-header">
                <h2>🔋 Quản Lý Pin Xe Máy Điện</h2>
                <button class="btn btn-secondary refresh-data-btn">
                  🔄 Cập Nhật Dữ Liệu
                </button>
              </div>

              ${this.currentVehicle ? this.renderDetailedView() : this.renderVehicleSelection()}
            </div>
          `;
        }

        renderVehicleSelection() {
          return `
            <div class="vehicle-selection">
              <h3>Chọn Xe Máy Điện</h3>
              <div class="vehicle-grid">
                ${Object.values(this.userBatteries).map(vehicle => `
                  <div class="vehicle-card">
                    <div class="vehicle-info">
                      <h4>${vehicle.icon} ${vehicle.name}</h4>
                      <p>ID: ${vehicle.id}</p>
                      <div class="battery-preview">
                        <div class="charge-level">
                          <span class="charge-percent">${vehicle.currentCharge}%</span>
                          <div class="charge-bar">
                            <div class="charge-fill" style="width: ${vehicle.currentCharge}%"></div>
                          </div>
                        </div>
                        <div class="health-indicator">
                          <span class="health-percent ${this.getHealthClass(vehicle.health)}">
                            ${vehicle.health}% Health
                          </span>
                        </div>
                      </div>
                    </div>
                    <button class="btn btn-primary select-vehicle-btn" data-vehicle-id="${vehicle.id}">
                      Chi Tiết
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        renderDetailedView() {
          const vehicle = this.currentVehicle;
          const history = this.healthHistory[vehicle.id] || [];
          const latestHistory = history.slice(-30);

          return `
            <div class="detailed-battery-view">
              <div class="vehicle-header">
                <h3>📊 ${vehicle.name} - Chi Tiết Pin</h3>
                <div class="last-updated">
                  Cập nhật lần cuối: ${new Date(vehicle.lastChecked).toLocaleString('vi-VN')}
                </div>
              </div>

              <div class="battery-metrics-grid">
                <div class="metric-card current-status">
                  <h4>🔋 Trạng Thái Hiện Tại</h4>
                  <div class="large-charge-display">
                    <div class="charge-circle">
                      <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"/>
                        <circle cx="50" cy="50" r="45" stroke="${this.getChargeColor(vehicle.currentCharge)}" 
                                stroke-width="8" fill="none" stroke-dasharray="283" 
                                stroke-dashoffset="${283 - (283 * vehicle.currentCharge / 100)}"
                                transform="rotate(-90 50 50)"/>
                      </svg>
                      <div class="charge-text">
                        <span class="charge-number">${vehicle.currentCharge}</span>
                        <span class="charge-unit">%</span>
                      </div>
                    </div>
                    <div class="range-estimate">
                      <strong>Quãng đường dự kiến:</strong><br>
                      ${this.calculateRange(vehicle)}
                    </div>
                  </div>
                </div>

                <div class="metric-card health-status">
                  <h4>💊 Độ Chai Pin</h4>
                  <div class="health-gauge">
                    <div class="health-bar">
                      <div class="health-fill ${this.getHealthClass(vehicle.health)}" 
                           style="width: ${vehicle.health}%"></div>
                    </div>
                    <div class="health-value">
                      <span class="health-number">${vehicle.health}%</span>
                      <span class="health-label">${this.getHealthStatus(vehicle.health)}</span>
                    </div>
                  </div>
                  <div class="health-details">
                    <div class="detail-item">
                      <span>Chu kỳ sạc:</span>
                      <strong>${vehicle.cycleCount} lần</strong>
                    </div>
                    <div class="detail-item">
                      <span>Dung lượng gốc:</span>
                      <strong>${vehicle.batteryCapacity} kWh</strong>
                    </div>
                    <div class="detail-item">
                      <span>Dung lượng hiện tại:</span>
                      <strong>${(vehicle.batteryCapacity * vehicle.health / 100).toFixed(1)} kWh</strong>
                    </div>
                  </div>
                </div>

                <div class="metric-card battery-info">
                  <h4>📋 Thông Tin Pin</h4>
                  <div class="info-list">
                    <div class="info-item">
                      <span class="info-label">Mã pin:</span>
                      <span class="info-value">${vehicle.batteryId}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Ngày sản xuất:</span>
                      <span class="info-value">${new Date(vehicle.manufactureDate).toLocaleDateString('vi-VN')}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Tuổi pin:</span>
                      <span class="info-value">${this.calculateBatteryAge(vehicle.manufactureDate)}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">Nhiệt độ pin:</span>
                      <span class="info-value">${latestHistory.length > 0 ? latestHistory[latestHistory.length - 1].temperature + '°C' : 'N/A'}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="chart-section">
                <h4>📈 Lịch Sử Độ Chai Pin</h4>
                <div class="chart-container">
                  ${this.renderHealthChart(latestHistory)}
                </div>
              </div>

              <div class="recommendations-section">
                <h4>💡 Khuyến Nghị</h4>
                <div class="recommendations-grid">
                  ${this.generateRecommendations(vehicle).map(rec => `
                    <div class="recommendation-card ${rec.type}">
                      <div class="rec-icon">${rec.icon}</div>
                      <div class="rec-content">
                        <h5>${rec.title}</h5>
                        <p>${rec.description}</p>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="export-section">
                <button class="btn btn-success export-report-btn">
                  📊 Xuất Báo Cáo Pin
                </button>
              </div>
            </div>
          `;
        }

        getHealthClass(health) {
          if (health >= 90) return 'excellent';
          if (health >= 80) return 'good';
          if (health >= 70) return 'fair';
          return 'poor';
        }

        getHealthStatus(health) {
          if (health >= 90) return 'Tuyệt vời';
          if (health >= 80) return 'Tốt';
          if (health >= 70) return 'Trung bình';
          return 'Cần chú ý';
        }

        getChargeColor(charge) {
          if (charge >= 70) return '#4CAF50';
          if (charge >= 30) return '#FF9800';
          return '#F44336';
        }

        calculateRange(vehicle) {
          const efficiency = 6;
          const usableCapacity = vehicle.batteryCapacity * vehicle.health / 100;
          const currentEnergy = usableCapacity * vehicle.currentCharge / 100;
          const range = Math.floor(currentEnergy * efficiency);
          return `${range} km`;
        }

        calculateBatteryAge(manufactureDate) {
          const now = new Date();
          const manufacture = new Date(manufactureDate);
          const diffTime = Math.abs(now - manufacture);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          const years = Math.floor(diffDays / 365);
          const months = Math.floor((diffDays % 365) / 30);
          return `${years} năm ${months} tháng`;
        }

        renderHealthChart(history) {
          if (history.length === 0) return '<p>Không có dữ liệu lịch sử</p>';

          const maxHealth = Math.max(...history.map(h => h.health));
          const minHealth = Math.min(...history.map(h => h.health));
          const range = maxHealth - minHealth || 1;

          return `
            <div class="simple-chart">
              <div class="chart-y-axis">
                <span>${Math.ceil(maxHealth)}%</span>
                <span>${Math.ceil((maxHealth + minHealth) / 2)}%</span>
                <span>${Math.floor(minHealth)}%</span>
              </div>
              <div class="chart-area">
                <svg viewBox="0 0 400 200" class="chart-svg">
                  <polyline
                    fill="none"
                    stroke="#4CAF50"
                    stroke-width="2"
                    points="${history.map((point, index) => {
                      const x = (index / (history.length - 1)) * 380 + 10;
                      const y = 190 - ((point.health - minHealth) / range) * 180;
                      return `${x},${y}`;
                    }).join(' ')}"
                  />
                  ${history.map((point, index) => {
                    const x = (index / (history.length - 1)) * 380 + 10;
                    const y = 190 - ((point.health - minHealth) / range) * 180;
                    return `<circle cx="${x}" cy="${y}" r="3" fill="#4CAF50"/>`;
                  }).join('')}
                </svg>
              </div>
              <div class="chart-x-axis">
                <span>${history[0].date}</span>
                <span>${history[Math.floor(history.length / 2)].date}</span>
                <span>${history[history.length - 1].date}</span>
              </div>
            </div>
          `;
        }

        generateRecommendations(vehicle) {
          const recommendations = [];

          if (vehicle.currentCharge < 20) {
            recommendations.push({
              type: 'warning',
              icon: '⚠️',
              title: 'Pin Thấp',
              description: 'Nên sạc pin sớm để tránh hỏng pin do xả quá sâu.'
            });
          } else if (vehicle.currentCharge > 90) {
            recommendations.push({
              type: 'info',
              icon: 'ℹ️',
              title: 'Pin Đầy',
              description: 'Không nên sạc 100% thường xuyên để bảo vệ pin.'
            });
          }

          if (vehicle.health < 80) {
            recommendations.push({
              type: 'warning',
              icon: '🔧',
              title: 'Kiểm Tra Pin',
              description: 'Độ chai pin đã cao, nên kiểm tra và bảo dưỡng định kỳ.'
            });
          }

          if (vehicle.cycleCount > 500) {
            recommendations.push({
              type: 'info',
              icon: '🔄',
              title: 'Chu Kỳ Sạc Cao',
              description: 'Pin đã qua nhiều chu kỳ sạc, hãy chú ý theo dõi độ chai.'
            });
          }

          recommendations.push({
            type: 'success',
            icon: '✅',
            title: 'Sạc Thông Minh',
            description: 'Duy trì mức pin 20-80% để tối ưu tuổi thọ pin.'
          });

          return recommendations;
        }

        selectVehicle(vehicleId) {
          this.currentVehicle = this.userBatteries[vehicleId];
          this.renderDashboard();
        }

        refreshBatteryData() {
          Object.values(this.userBatteries).forEach(vehicle => {
            vehicle.currentCharge = Math.max(0, Math.min(100, 
              vehicle.currentCharge + (Math.random() - 0.5) * 10
            ));
            vehicle.lastChecked = new Date().toISOString();
          });

          this.saveUserBatteries();
          this.renderDashboard();
          alert('Đã cập nhật dữ liệu pin mới nhất!');
        }

        exportHealthReport() {
          if (!this.currentVehicle) return;

          const report = this.generateHealthReport(this.currentVehicle);
          const blob = new Blob([report], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `battery-report-${this.currentVehicle.id}-${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          
          URL.revokeObjectURL(url);
          alert('Đã xuất báo cáo pin thành công!');
        }

        generateHealthReport(vehicle) {
          const history = this.healthHistory[vehicle.id] || [];
          
          return `
BÁO CÁO TÌNH TRẠNG PIN XE ĐIỆN
=====================================

Thông tin xe:
- Tên xe: ${vehicle.name}
- Mã xe: ${vehicle.id}
- Mã pin: ${vehicle.batteryId}

Tình trạng hiện tại:
- Mức pin: ${vehicle.currentCharge}%
- Độ chai pin: ${vehicle.health}%
- Chu kỳ sạc: ${vehicle.cycleCount} lần
- Dung lượng pin: ${vehicle.batteryCapacity} kWh
- Dung lượng hiện tại: ${(vehicle.batteryCapacity * vehicle.health / 100).toFixed(1)} kWh

Thông tin sản xuất:
- Ngày sản xuất: ${new Date(vehicle.manufactureDate).toLocaleDateString('vi-VN')}
- Tuổi pin: ${this.calculateBatteryAge(vehicle.manufactureDate)}

Lịch sử độ chai pin (30 điểm gần nhất):
${history.slice(-30).map(h => 
  `${h.date}: ${h.health}% (${h.chargeLevel}% sạc, ${h.temperature}°C)`
).join('\n')}

Khuyến nghị:
${this.generateRecommendations(vehicle).map(r => 
  `- ${r.title}: ${r.description}`
).join('\n')}

Báo cáo tạo lúc: ${new Date().toLocaleString('vi-VN')}
          `.trim();
        }

        renderDashboard() {
          const content = this.renderBatteryHealthDashboard();
          const batteryTab = document.querySelector('#batteryHealthContent');
          if (batteryTab) {
            batteryTab.innerHTML = content;
          }
          return content;
        }
      }

      // Debug: Log that BatteryHealthSystem class is defined
      console.log('BatteryHealthSystem class defined:', typeof BatteryHealthSystem);

      // Payment method selection
      document.addEventListener('change', function(e) {
        if (e.target.name === 'payment-method') {
          document.querySelectorAll('.payment-method').forEach(method => {
            method.classList.remove('active');
          });
          e.target.closest('.payment-method').classList.add('active');
          
          const creditCardForm = document.getElementById('credit-card-form');
          if (e.target.value === 'credit-card') {
            creditCardForm.style.display = 'block';
          } else {
            creditCardForm.style.display = 'none';
          }
        }
      });
      
      // Pre-initialize BatteryHealthSystem for faster loading
      console.log('Pre-initializing BatteryHealthSystem...');
      try {
        if (typeof BatteryHealthSystem !== 'undefined') {
          window.batteryHealthSystem = new BatteryHealthSystem();
          console.log('BatteryHealthSystem pre-initialized successfully');
        } else {
          console.warn('BatteryHealthSystem class not available yet');
        }
      } catch (error) {
        console.error('Error pre-initializing BatteryHealthSystem:', error);
      }

      // Clear all modals on page load to ensure UI is not blocked
      console.log('Clearing all modals on page load...');
      const modalIds = ['loginModal', 'registerModal', 'payment-modal', 'contract-modal'];
      modalIds.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
          modal.style.visibility = 'hidden';
          modal.style.opacity = '0';
          modal.style.pointerEvents = 'none';
          console.log(`Cleared modal: ${modalId}`);
        }
      });

      // Also remove any dynamic modals that might exist
      const dynamicModals = document.querySelectorAll('.plan-selection-modal, .vehicle-selection-modal');
      dynamicModals.forEach(modal => {
        modal.remove();
        console.log('Removed dynamic modal');
      });

      // Ensure main content is visible and interactive
      const mainContent = document.querySelector('main');
      const header = document.querySelector('header');
      const footer = document.querySelector('footer');
      
      if (mainContent) {
        mainContent.style.display = 'block';
        mainContent.style.pointerEvents = 'auto';
      }
      if (header) {
        header.style.display = 'block';
        header.style.pointerEvents = 'auto';
      }
      if (footer) {
        footer.style.display = 'block';
        footer.style.pointerEvents = 'auto';
      }

      console.log('Page initialization complete - UI should be clickable now');
    });

    // Payment Sub-Tab Functions
    function showPaymentSubTab(tabName) {
      // Remove active class from all sub-tabs and contents
      document.querySelectorAll('.payment-sub-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.payment-sub-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and content
      event.target.classList.add('active');
      document.getElementById(`${tabName}-subtab`).classList.add('active');
      
      // Update current plan info when showing payment tab
      if (tabName === 'payment' && auth.currentUser && auth.currentUser.selectedPlan) {
        updateCurrentPlanInfo();
      }
    }

    function updateCurrentPlanInfo() {
      const plan = auth.currentUser.selectedPlan;
      if (plan) {
        document.getElementById('current-plan-name').textContent = plan.name;
        document.getElementById('current-plan-price').textContent = plan.price;
        document.getElementById('current-plan-features').textContent = plan.features.join(' • ');
        document.getElementById('plan-payment-amount').textContent = plan.price.split('/')[0];
      }
    }

    function selectPaymentMethod(method) {
      // Remove selected class from all methods
      document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
      
      // Add selected class to clicked method
      event.currentTarget.classList.add('selected');
      
      // Update radio button
      document.querySelector(`input[name="payment-method"][value="${method}"]`).checked = true;
    }

    function processPayment() {
      const selectedMethod = document.querySelector('input[name="payment-method"]:checked');
      if (!selectedMethod) {
        showToast('Vui lòng chọn phương thức thanh toán', 'error');
        return;
      }
      
      showToast('Đang xử lý thanh toán...', 'info');
      
      // Simulate payment processing
      setTimeout(() => {
        showToast('Thanh toán thành công!', 'success');
        
        // Add to payment history
        const newRow = `
          <tr>
            <td>#PAY00${Date.now().toString().slice(-3)}</td>
            <td>${new Date().toLocaleString('vi-VN')}</td>
            <td>Thanh toán gói ${auth.currentUser.selectedPlan.name}</td>
            <td>${auth.currentUser.selectedPlan.price.split('/')[0]}</td>
            <td>${getMethodName(selectedMethod.value)}</td>
            <td><span class="status success">Thành công</span></td>
            <td><button class="action-btn" onclick="viewPaymentDetail('PAY00${Date.now().toString().slice(-3)}')">Chi tiết</button></td>
          </tr>
        `;
        document.getElementById('payment-history-table').insertAdjacentHTML('afterbegin', newRow);
      }, 2000);
    }

    function getMethodName(value) {
      const names = {
        'momo': 'Ví MoMo',
        'zalopay': 'ZaloPay', 
        'credit-card': 'Thẻ tín dụng',
        'bank-transfer': 'Chuyển khoản'
      };
      return names[value] || value;
    }

    function toggleAutoPay() {
      const checkbox = document.getElementById('autopay-enabled');
      const settings = document.getElementById('autopay-settings');
      const statusText = document.getElementById('autopay-status-text');
      
      if (checkbox.checked) {
        settings.style.display = 'block';
        statusText.textContent = 'Bật - Thanh toán tự động mỗi tháng';
        showToast('Đã bật thanh toán tự động', 'success');
      } else {
        settings.style.display = 'none';
        statusText.textContent = 'Tắt - Bạn sẽ thanh toán thủ công mỗi tháng';
        showToast('Đã tắt thanh toán tự động', 'info');
      }
    }

    function selectAutoPayMethod(method) {
      document.querySelector(`input[name="autopay-method"][value="${method}"]`).checked = true;
      
      // Visual feedback
      document.querySelectorAll('.autopay-method').forEach(el => el.style.background = 'rgba(255,255,255,.05)');
      event.currentTarget.style.background = 'rgba(79,140,255,.2)';
    }

    function updateAutoPaySettings() {
      const day = document.getElementById('autopay-day').value;
      showToast(`Đã cập nhật ngày thanh toán: ${day === 'end' ? 'Cuối tháng' : 'Ngày ' + day}`, 'info');
    }

    function saveAutoPaySettings() {
      const enabled = document.getElementById('autopay-enabled').checked;
      const day = document.getElementById('autopay-day').value;
      const method = document.querySelector('input[name="autopay-method"]:checked').value;
      
      // Save to localStorage
      const autoPaySettings = {
        enabled,
        day,
        method,
        savedAt: new Date().toISOString()
      };
      localStorage.setItem('autoPaySettings', JSON.stringify(autoPaySettings));
      
      showToast('Đã lưu cài đặt thanh toán tự động!', 'success');
    }

    function testAutoPay() {
      showToast('Đang test thanh toán tự động...', 'info');
      
      setTimeout(() => {
        showToast('Test thành công! Hệ thống hoạt động bình thường.', 'success');
      }, 1500);
    }
    // Settings Functions
    function toggleSetting(element) {
      element.classList.toggle('active');
      const isActive = element.classList.contains('active');
      showToast(`Cài đặt đã được ${isActive ? 'bật' : 'tắt'}`, 'success');
    }

    function editProfile() {
      showToast('Chức năng chỉnh sửa hồ sơ sẽ được cập nhật sau', 'info');
    }

    function changePassword() {
      showToast('Chức năng đổi mật khẩu sẽ được cập nhật sau', 'info');
    }

    function setup2FA() {
      showToast('Chức năng xác thực 2 bước sẽ được cập nhật sau', 'info');
    }

    function exportUserData() {
      showToast('Đang xuất dữ liệu người dùng...', 'success');
      // Simulate data export
      setTimeout(() => {
        const userData = {
          name: auth.currentUser.name,
          email: auth.currentUser.username,
          role: auth.currentUser.role,
          exportDate: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `user-data-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Đã xuất dữ liệu thành công!', 'success');
      }, 2000);
    }

    function deleteAccount() {
      if (confirm('Bạn có chắc chắn muốn xóa tài khoản? Hành động này không thể hoàn tác.')) {
        showToast('Yêu cầu xóa tài khoản đã được gửi đến admin', 'warning');
      }
    }

    // Staff Manual Battery Swap Functions
    function lookupCustomer() {
      const customerId = document.getElementById('customer-id').value;
      if (!customerId) {
        showToast('Vui lòng nhập mã khách hàng hoặc số điện thoại', 'warning');
        return;
      }
      
      // Simulate customer lookup
      showToast('Đang tra cứu thông tin khách hàng...', 'success');
      setTimeout(() => {
        showToast(`Tìm thấy khách hàng: Nguyễn Văn A - ${customerId}`, 'success');
      }, 1500);
    }

    function startManualSwap() {
      const customerId = document.getElementById('customer-id').value;
      const vehicleType = document.getElementById('vehicle-type').value;
      const oldBattery = document.getElementById('old-battery').value;
      const newBattery = document.getElementById('new-battery').value;

      if (!customerId || !vehicleType || !oldBattery || !newBattery) {
        showToast('Vui lòng điền đầy đủ thông tin', 'warning');
        return;
      }

      // Show driver confirmation modal
      showDriverConfirmation({
        customer: customerId,
        vehicle: vehicleType,
        oldBattery: oldBattery,
        newBattery: newBattery
      });
    }

    function processSwapRequest(requestId, priority) {
      showToast(`Đang xử lý yêu cầu ${requestId} (${priority} priority)...`, 'success');
      
      // Simulate processing
      setTimeout(() => {
        const requestElement = document.querySelector(`[onclick*="${requestId}"]`).closest('.swap-request-item');
        requestElement.style.opacity = '0.6';
        requestElement.querySelector('.request-actions').innerHTML = `
          <span class="status warning">Đang xử lý</span>
          <button class="btn btn-success" onclick="completeSwapRequest('${requestId}')">Hoàn thành</button>
        `;
        showToast(`Yêu cầu ${requestId} đã được tiếp nhận`, 'success');
      }, 1000);
    }

    function rejectSwapRequest(requestId) {
      if (confirm('Bạn có chắc chắn muốn từ chối yêu cầu này?')) {
        const requestElement = document.querySelector(`[onclick*="${requestId}"]`).closest('.swap-request-item');
        requestElement.style.display = 'none';
        showToast(`Đã từ chối yêu cầu ${requestId}`, 'warning');
      }
    }

    function completeSwapRequest(requestId) {
      const requestElement = document.querySelector(`[onclick*="${requestId}"]`).closest('.swap-request-item');
      requestElement.style.display = 'none';
      showToast(`Đã hoàn thành yêu cầu ${requestId}`, 'success');
    }

    function manageBattery(batteryId) {
      showToast(`Đang quản lý pin ${batteryId}`, 'info');
    }

    // Driver Confirmation Functions
    let currentSwapData = null;

    function showDriverConfirmation(swapData) {
      currentSwapData = swapData;
      
      document.getElementById('swap-details').innerHTML = `
        <strong>Khách hàng:</strong> ${swapData.customer}<br>
        <strong>Loại xe:</strong> ${swapData.vehicle}<br>
        <strong>Pin cũ:</strong> ${swapData.oldBattery}<br>
        <strong>Pin mới:</strong> ${swapData.newBattery}<br>
        <strong>Thời gian:</strong> ${new Date().toLocaleString('vi-VN')}
      `;
      
      document.getElementById('driver-confirmation-modal').style.display = 'flex';
      
      // Enable confirm button when checkbox is checked
      document.getElementById('driver-agreement').addEventListener('change', function() {
        document.getElementById('confirm-swap-btn').disabled = !this.checked;
      });
    }

    function closeDriverConfirmation() {
      document.getElementById('driver-confirmation-modal').style.display = 'none';
      document.getElementById('driver-agreement').checked = false;
      document.getElementById('confirm-swap-btn').disabled = true;
      currentSwapData = null;
    }

    function confirmDriverSwap() {
      if (!currentSwapData) return;
      
      showToast('Đang thực hiện đổi pin...', 'success');
      closeDriverConfirmation();
      
      // Simulate swap process with steps
      simulateDriverSwapProcess();
    }

    function simulateDriverSwapProcess() {
      const steps = [
        'Đang xác thực danh tính...',
        'Đang mở khóa pin cũ...',
        'Vui lòng tháo pin cũ và lắp pin mới...',
        'Đang kiểm tra kết nối pin mới...',
        'Đang cập nhật hệ thống...',
        'Hoàn thành đổi pin!'
      ];
      
      let currentStep = 0;
      
      function nextStep() {
        if (currentStep < steps.length) {
          showToast(steps[currentStep], currentStep === steps.length - 1 ? 'success' : 'info');
          currentStep++;
          
          if (currentStep < steps.length) {
            setTimeout(nextStep, 2000);
          } else {
            // Reset form after completion
            setTimeout(() => {
              document.getElementById('customer-id').value = '';
              document.getElementById('vehicle-type').value = '';
              document.getElementById('old-battery').value = '';
              document.getElementById('new-battery').value = '';
            }, 1000);
          }
        }
      }
      
      nextStep();
    }

    // PDF Report Functions
    function createReportSchedule() {
      const reportType = document.getElementById('report-type').value;
      const email = document.getElementById('recipient-email').value;
      const time = document.getElementById('send-time').value;

      if (!email || !time) {
        showToast('Vui lòng điền đầy đủ thông tin', 'warning');
        return;
      }

      showToast(`Đã tạo lịch ${reportType} gửi đến ${email} lúc ${time}`, 'success');
      
      // Add to scheduled reports list
      const scheduleId = 'SCH' + Date.now();
      const scheduleItem = document.createElement('div');
      scheduleItem.className = 'schedule-item';
      scheduleItem.innerHTML = `
        <div class="schedule-info">
          <strong>${reportType}</strong><br>
          <span class="muted">${email} - ${time}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="schedule-status active">Đang hoạt động</span>
          <button class="btn" onclick="editSchedule('${scheduleId}')">Sửa</button>
          <button class="btn btn-danger" onclick="deleteSchedule('${scheduleId}')">Xóa</button>
        </div>
      `;
      
      document.getElementById('scheduled-reports').appendChild(scheduleItem);
      
      // Reset form
      document.getElementById('recipient-email').value = '';
      document.getElementById('send-time').value = '08:00';
    }

    function sendTestReport() {
      showToast('Đang gửi báo cáo thử nghiệm...', 'success');
      setTimeout(() => {
        showToast('Đã gửi báo cáo thử nghiệm thành công!', 'success');
      }, 2000);
    }

    function editSchedule(scheduleId) {
      showToast(`Chỉnh sửa lịch ${scheduleId}`, 'info');
    }

    function deleteSchedule(scheduleId) {
      if (confirm('Bạn có chắc chắn muốn xóa lịch này?')) {
        const scheduleElement = document.querySelector(`[onclick*="${scheduleId}"]`).closest('.schedule-item');
        scheduleElement.remove();
        showToast(`Đã xóa lịch ${scheduleId}`, 'success');
      }
    }

    function exportInstantReport() {
      showToast('Đang tạo báo cáo PDF...', 'success');
      
      setTimeout(() => {
        // Simulate PDF generation and download
        const reportContent = `
SWP201 - BÁO CÁO HỆ THỐNG
========================

Ngày tạo: ${new Date().toLocaleDateString('vi-VN')}
Thời gian: ${new Date().toLocaleTimeString('vi-VN')}

THỐNG KÊ TỔNG QUAN:
- Tổng người dùng: 1,247
- Trạm hoạt động: 24/26
- Doanh thu: 52,800,000 VNĐ
- Uptime hệ thống: 98.2%

TÌNH TRẠNG TRẠM:
- Trạm Bùi Thị Xuân: Hoạt động (8 pin)
- Trạm Cầu Giấy: Hoạt động (12 pin)
- Trạm Hải Châu: Hoạt động (6 pin)
- Trạm Thủ Đức: Hoạt động (15 pin)
- Trạm Long Biên: Bảo trì
- Trạm Sơn Trà: Hoạt động (9 pin)

GIAO DỊCH GẦN ĐÂY:
- #TX001: Nguyễn Văn A - 89,000đ - Thành công
- #TX002: Trần Thị B - 299,000đ - Chờ xử lý
- #TX003: Lê Văn C - 89,000đ - Thất bại

Báo cáo được tạo tự động bởi hệ thống SWP201.
        `;
        
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SWP201-Report-${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Đã xuất báo cáo thành công!', 'success');
      }, 3000);
    }
  </script>
</body>
</html>
